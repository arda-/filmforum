---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../layouts/Layout.astro';
import { getActiveSeries } from '../config/series';
import { toTitleCase } from '../utils/movieUtils';
import fs from 'node:fs';
import path from 'node:path';

// Build-time import of all poster images from src/assets/posters/
// Enables Astro to optimize them to WebP/AVIF with responsive srcsets
const posterGlob = import.meta.glob<{ default: ImageMetadata }>(
  '../assets/posters/*.{png,jpg,jpeg}',
  { eager: true }
);

// Create a lookup map from poster filenames to image modules
const posterMap = Object.entries(posterGlob).reduce((map, [filePath, mod]) => {
  const filename = filePath.split('/').pop()?.replace(/\.(png|jpg|jpeg)$/, '');
  if (filename && mod.default) {
    map[filename] = mod.default;
  }
  return map;
}, {} as Record<string, ImageMetadata>);

// Get poster image module by URL
function getPosterImage(posterUrl: string | undefined): ImageMetadata | undefined {
  if (!posterUrl) return undefined;
  const filename = posterUrl.split('/').pop()?.replace(/\.(png|jpg|jpeg)$/, '');
  return filename ? posterMap[filename] : undefined;
}

const activeSeries = getActiveSeries();

// Load movie data at build time to get "showing today" films
interface MovieEntry {
  Movie: string;
  Time: string;
  Datetime: string;
  director?: string;
  year?: string;
  poster_url?: string;
  runtime?: string;
  actors?: string;
}

// Build a mapping of poster URLs to optimized image metadata for client-side use
// This allows us to pass optimized image info to the client script
const posterUrlMap: Record<string, { src: string; width: number; height: number }> = {};
for (const [filename, metadata] of Object.entries(posterMap)) {
  posterUrlMap[`/posters/${filename}.png`] = {
    src: metadata.src,
    width: metadata.width,
    height: metadata.height
  };
  posterUrlMap[`/posters/${filename}.jpg`] = {
    src: metadata.src,
    width: metadata.width,
    height: metadata.height
  };
  posterUrlMap[`/posters/${filename}.jpeg`] = {
    src: metadata.src,
    width: metadata.width,
    height: metadata.height
  };
}

// Gather upcoming films from all active series
let showingToday: { film: MovieEntry; seriesId: string }[] = [];

for (const series of activeSeries) {
  const dataPath = path.join(process.cwd(), 'public', series.dataFile);
  try {
    const movieData: MovieEntry[] = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

    // Get today's date (build time), but since we're building statically,
    // use the series start date to show "opening day" films as a reasonable default
    // In production with SSR this would be dynamic
    const allDates = [...new Set(movieData.map(m => m.Datetime.split('T')[0]))].sort();
    const todayStr = new Date().toISOString().split('T')[0];

    // Find the nearest date with showings (today or next upcoming)
    let targetDate = allDates.find(d => d >= todayStr) || allDates[0];

    const todayMovies = movieData.filter(m => m.Datetime.split('T')[0] === targetDate);

    // Deduplicate by title (only show each film once)
    const seen = new Set<string>();
    for (const m of todayMovies) {
      if (!seen.has(m.Movie) && m.poster_url) {
        seen.add(m.Movie);
        showingToday.push({ film: m, seriesId: series.id });
      }
    }
  } catch (e) {
    if ((e as NodeJS.ErrnoException).code !== 'ENOENT') {
      console.error(`Error loading series data for ${series.id}:`, e);
    }
  }
}

---

<Layout
  title="FilmForum - Discover and Plan Your Film Series"
  description="Explore curated film series, browse showtimes, and plan your cinema visits. Interactive calendars and movie lists for film enthusiasts at Film Forum."
  canonical="/"
>
  <main class="landing">
    <h1 class="site-title">FilmForum</h1>
    <p class="site-blurb">
      An interactive explorer for <a href="https://filmforum.org" class="ff-link">Film Forum</a> repertory series.
      Browse schedules, filter showtimes, and plan your trips.
    </p>

    {activeSeries.length > 0 && (
      <section class="series-list">
        <h2 class="section-heading">Currently Running</h2>
        <ul class="series-cards">
          {activeSeries.map(series => (
            <li>
              <a href={`/s/${series.id}`} class="series-card">
                <span class="series-name">{series.name}</span>
                <span class="series-subtitle">{series.subtitle}</span>
                <span class="series-meta">{series.venueName} &middot; {series.dateRange}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {showingToday.length > 0 && (
      <section class="today-section">
        <h2 class="section-heading">Showing Today</h2>
        <div class="today-grid" id="today-grid">
          {showingToday.map(({ film, seriesId }) => {
            const image = getPosterImage(film.poster_url);
            return (
            <a href={`/s/${seriesId}/calendar`} class="poster-card">
              {image && <Image src={image} alt={film.Movie} class="poster-image" width={290} height={386} loading="lazy" />}
              <div class="poster-scrim"></div>
              <div class="progressive-blur">
                <div class="blur-layer layer-1"></div>
                <div class="blur-layer layer-2"></div>
                <div class="blur-layer layer-3"></div>
                <div class="blur-layer layer-4"></div>
                <div class="blur-layer layer-5"></div>
                <div class="blur-layer layer-6"></div>
              </div>
              <div class="poster-info">
                <span class="poster-title">{toTitleCase(film.Movie)}</span>
                <span class="poster-meta">{[film.director, film.year].filter(Boolean).join(' \u00b7 ')}</span>
                <span class="poster-showtime">{film.Time}</span>
              </div>
            </a>
            );
          })}
        </div>
      </section>
    )}

    <section class="demos-section">
      <h2 class="section-heading">Demos</h2>
      <a href="/demo" class="demo-link">
        <span class="demo-title">Component Demos</span>
        <span class="demo-description">UI components, animations, and testing tools</span>
      </a>
    </section>
  </main>

  <!-- Embed active series config and poster mappings for client-side rendering -->
  <script id="series-config" type="application/json" set:html={JSON.stringify({
    series: activeSeries.map(s => ({ id: s.id, dataFile: s.dataFile })),
    posterMap: posterUrlMap
  })} />

  <script>
    // Live update "Showing Today" based on current browser time
    interface MovieEntry {
      Movie: string;
      Time: string;
      Datetime: string;
      director?: string;
      year?: string;
      poster_url?: string;
    }

    interface SeriesConfig {
      id: string;
      dataFile: string;
    }

    interface PosterMetadata {
      src: string;
      width: number;
      height: number;
    }

    interface Config {
      series: SeriesConfig[];
      posterMap: Record<string, PosterMetadata>;
    }

    function toTitleCase(str: string): string {
      return str.toLowerCase().split(' ').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function updateShowingToday() {
      const configEl = document.getElementById('series-config');
      if (!configEl || !configEl.textContent) return;

      const config: Config = JSON.parse(configEl.textContent);
      const todayStr = new Date().toISOString().split('T')[0];

      interface FilmWithSeries {
        film: MovieEntry;
        seriesId: string;
        showtimes: string[];
      }

      const showingToday: FilmWithSeries[] = [];

      // Fetch and process each series
      for (const series of config.series) {
        try {
          const response = await fetch(series.dataFile);
          if (!response.ok) continue;

          const movieData: MovieEntry[] = await response.json();

          // Get all available dates and find the nearest one (today or next upcoming)
          const allDates = [...new Set(movieData.map(m => m.Datetime.split('T')[0]))].sort();
          const targetDate = allDates.find(d => d >= todayStr) || allDates[0];

          // Get today's movies
          const todayMovies = movieData.filter(m => m.Datetime.split('T')[0] === targetDate);

          // Group by movie title to collect all showtimes
          const movieMap = new Map<string, FilmWithSeries>();
          for (const movie of todayMovies) {
            if (!movie.poster_url) continue;

            if (movieMap.has(movie.Movie)) {
              movieMap.get(movie.Movie)!.showtimes.push(movie.Time);
            } else {
              movieMap.set(movie.Movie, {
                film: movie,
                seriesId: series.id,
                showtimes: [movie.Time]
              });
            }
          }

          showingToday.push(...movieMap.values());
        } catch (e) {
          console.error(`Error loading series ${series.id}:`, e);
        }
      }

      // Update the DOM
      const gridEl = document.getElementById('today-grid');
      if (!gridEl) return;

      if (showingToday.length === 0) {
        gridEl.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No films showing today</p>';
        return;
      }

      gridEl.innerHTML = showingToday.map(({ film, seriesId, showtimes }) => {
        const posterMeta = film.poster_url && config.posterMap[film.poster_url];
        const imgTag = posterMeta
          ? `<img src="${escapeHtml(posterMeta.src)}" alt="${escapeHtml(film.Movie)}" class="poster-image" loading="lazy" width="${posterMeta.width}" height="${posterMeta.height}" />`
          : '';

        const title = escapeHtml(toTitleCase(film.Movie));
        const metaParts = [film.director, film.year].filter(Boolean);
        const meta = metaParts.length > 0 ? escapeHtml(metaParts.join(' · ')) : '';
        const showtimeText = escapeHtml(showtimes.join(', '));

        return `
          <a href="/s/${escapeHtml(seriesId)}/calendar" class="poster-card">
            ${imgTag}
            <div class="poster-scrim"></div>
            <div class="progressive-blur">
              <div class="blur-layer layer-1"></div>
              <div class="blur-layer layer-2"></div>
              <div class="blur-layer layer-3"></div>
              <div class="blur-layer layer-4"></div>
              <div class="blur-layer layer-5"></div>
              <div class="blur-layer layer-6"></div>
            </div>
            <div class="poster-info">
              <span class="poster-title">${title}</span>
              ${meta ? `<span class="poster-meta">${meta}</span>` : ''}
              <span class="poster-showtime">${showtimeText}</span>
            </div>
          </a>
        `;
      }).join('');
    }

    // Update on page load
    updateShowingToday();

    // Update when page becomes visible (user switches back to tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        updateShowingToday();
      }
    });

    // Also update every 5 minutes in case user keeps tab open past midnight
    setInterval(updateShowingToday, 5 * 60 * 1000);
  </script>
</Layout>

<style>
  .landing {
    max-width: 720px;
    margin: 0 auto;
    padding: 40px 20px;
    text-align: center;
  }

  .site-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 700;
    font-size: 2.4rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-primary);
    margin-bottom: 12px;
  }

  .site-blurb {
    color: var(--text-secondary);
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 40px;
  }

  .ff-link {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .section-heading {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-tertiary);
    margin-bottom: 16px;
  }

  /* Demos section */
  .demos-section {
    margin-top: 48px;
    padding-bottom: 48px;
  }

  .demo-link {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 20px 24px;
    border-radius: 10px;
    background: var(--bg-day-movies);
    border: 1px solid var(--bg-grid);
    text-decoration: none;
    transition: background 0.2s, border-color 0.2s;
  }

  .demo-link:hover {
    background: var(--bg-movie-hover);
    border-color: var(--accent);
  }

  .demo-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .demo-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  /* Series cards */
  .series-cards {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 48px;
  }

  .series-card {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 20px 24px;
    border-radius: 10px;
    background: var(--bg-day-movies);
    border: 1px solid var(--bg-grid);
    text-decoration: none;
    transition: background 0.15s, border-color 0.15s;
  }

  .series-card:hover {
    background: var(--bg-movie-hover);
    border-color: var(--accent);
  }

  .series-name {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    color: var(--text-primary);
  }

  .series-subtitle {
    font-size: 0.95rem;
    color: var(--text-secondary);
  }

  .series-meta {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    margin-top: 4px;
  }

  /* Today gallery */
  .today-section {
    margin-top: 0;
  }

  .today-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    text-align: left;
  }

  @media (min-width: 480px) {
    .today-grid {
      grid-template-columns: repeat(auto-fill, minmax(145px, 1fr));
      gap: 14px;
    }
  }

  .poster-card {
    position: relative;
    aspect-ratio: 3 / 4;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-movie);
    text-decoration: none;
    display: block;
    transition: transform 0.15s, box-shadow 0.15s;
  }

  .poster-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  }

  .poster-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Dark scrim for text readability */
  .poster-scrim {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60%;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.75) 0%,
      rgba(0, 0, 0, 0.35) 40%,
      transparent 100%
    );
    pointer-events: none;
  }

  /* Progressive blur — scoped to bottom 45% (text region only) */
  .progressive-blur {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 45%;
    pointer-events: none;
  }

  .blur-layer {
    position: absolute;
    inset: 0;
  }

  /* Scaled blur values for small cards, masks within the 45% container */
  .layer-1 {
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
    mask-image: linear-gradient(to top, transparent 50%, black 75%, black 100%);
    -webkit-mask-image: linear-gradient(to top, transparent 50%, black 75%, black 100%);
  }
  .layer-2 {
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    mask-image: linear-gradient(to top, transparent 35%, black 55%, black 80%, transparent 100%);
    -webkit-mask-image: linear-gradient(to top, transparent 35%, black 55%, black 80%, transparent 100%);
  }
  .layer-3 {
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
    mask-image: linear-gradient(to top, transparent 20%, black 40%, black 65%, transparent 85%);
    -webkit-mask-image: linear-gradient(to top, transparent 20%, black 40%, black 65%, transparent 85%);
  }
  .layer-4 {
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    mask-image: linear-gradient(to top, transparent 8%, black 25%, black 50%, transparent 70%);
    -webkit-mask-image: linear-gradient(to top, transparent 8%, black 25%, black 50%, transparent 70%);
  }
  .layer-5 {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    mask-image: linear-gradient(to top, transparent 0%, black 12%, black 35%, transparent 55%);
    -webkit-mask-image: linear-gradient(to top, transparent 0%, black 12%, black 35%, transparent 55%);
  }
  .layer-6 {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    mask-image: linear-gradient(to top, black 0%, black 15%, transparent 40%);
    -webkit-mask-image: linear-gradient(to top, black 0%, black 15%, transparent 40%);
  }

  .poster-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .poster-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    color: white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    line-height: 1.2;
  }

  .poster-meta {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
  }

  .poster-showtime {
    font-size: 0.75rem;
    color: var(--accent);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    font-weight: 500;
    margin-top: 2px;
  }
</style>
