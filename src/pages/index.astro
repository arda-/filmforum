---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../layouts/Layout.astro';
import { getActiveSeries } from '../config/series';
import { toTitleCase } from '../utils/movieUtils';
import fs from 'node:fs';
import path from 'node:path';

// Build-time import of all poster images from src/assets/posters/
// Enables Astro to optimize them to WebP/AVIF with responsive srcsets
const posterGlob = import.meta.glob<{ default: ImageMetadata }>(
  '../assets/posters/*.{png,jpg,jpeg}',
  { eager: true }
);

// Create a lookup map from poster filenames to image modules
const posterMap = Object.entries(posterGlob).reduce((map, [filePath, mod]) => {
  const filename = filePath.split('/').pop()?.replace(/\.(png|jpg|jpeg)$/, '');
  if (filename && mod.default) {
    map[filename] = mod.default;
  }
  return map;
}, {} as Record<string, ImageMetadata>);

// Get poster image module by URL
function getPosterImage(posterUrl: string | undefined): ImageMetadata | undefined {
  if (!posterUrl) return undefined;
  const filename = posterUrl.split('/').pop()?.replace(/\.(png|jpg|jpeg)$/, '');
  return filename ? posterMap[filename] : undefined;
}

const activeSeries = getActiveSeries();

// Load movie data at build time to get "showing today" films
interface MovieEntry {
  Movie: string;
  Time: string;
  Datetime: string;
  director?: string;
  year?: string;
  poster_url?: string;
  runtime?: string;
  actors?: string;
}

// Gather upcoming films from all active series, grouped by title with all showtimes
let showingToday: { film: MovieEntry; seriesId: string; showtimes: string[] }[] = [];
let buildDate = '';

for (const series of activeSeries) {
  const dataPath = path.join(process.cwd(), 'public', series.dataFile);
  try {
    const movieData: MovieEntry[] = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

    const allDates = [...new Set(movieData.map(m => m.Datetime.split('T')[0]))].sort();
    const todayStr = new Date().toISOString().split('T')[0];

    // Find the nearest date with showings (today or next upcoming)
    const targetDate = allDates.find(d => d >= todayStr) || allDates[0];
    if (!buildDate) buildDate = targetDate;

    const todayMovies = movieData.filter(m => m.Datetime.split('T')[0] === targetDate);

    // Group by title, collecting all showtimes
    const movieMap = new Map<string, { film: MovieEntry; seriesId: string; showtimes: string[] }>();
    for (const m of todayMovies) {
      if (!m.poster_url) continue;
      if (movieMap.has(m.Movie)) {
        movieMap.get(m.Movie)!.showtimes.push(m.Time);
      } else {
        movieMap.set(m.Movie, { film: m, seriesId: series.id, showtimes: [m.Time] });
      }
    }

    showingToday.push(...movieMap.values());
  } catch (e) {
    if ((e as NodeJS.ErrnoException).code !== 'ENOENT') {
      console.error(`Error loading series data for ${series.id}:`, e);
    }
  }
}

// Build poster URL -> optimized src mapping for client-side use
const posterUrlMap: Record<string, { src: string; width: number; height: number }> = {};
for (const [filename, metadata] of Object.entries(posterMap)) {
  for (const ext of ['png', 'jpg', 'jpeg']) {
    posterUrlMap[`/posters/${filename}.${ext}`] = {
      src: metadata.src,
      width: metadata.width,
      height: metadata.height,
    };
  }
}

---

<Layout
  title="FilmForum - Discover and Plan Your Film Series"
  description="Explore curated film series, browse showtimes, and plan your cinema visits. Interactive calendars and movie lists for film enthusiasts at Film Forum."
  canonical="/"
>
  <main class="landing">
    <h1 class="site-title">FilmForum</h1>
    <p class="site-blurb">
      An interactive explorer for <a href="https://filmforum.org" class="ff-link">Film Forum</a> repertory series.
      Browse schedules, filter showtimes, and plan your trips.
    </p>

    {activeSeries.length > 0 && (
      <section class="series-list">
        <h2 class="section-heading">Currently Running</h2>
        <ul class="series-cards">
          {activeSeries.map(series => (
            <li>
              <a href={`/s/${series.id}`} class="series-card">
                <span class="series-name">{series.name}</span>
                <span class="series-subtitle">{series.subtitle}</span>
                <span class="series-meta">{series.venueName} &middot; {series.dateRange}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {showingToday.length > 0 && (
      <section class="today-section">
        <h2 class="section-heading">Showing Today</h2>
        <div class="today-scroll" id="today-scroll" data-build-date={buildDate}>
          {showingToday.map(({ film, seriesId, showtimes }) => {
            const image = getPosterImage(film.poster_url);
            return (
            <a href={`/s/${seriesId}/calendar`} class="poster-card">
              {image && <Image src={image} alt={film.Movie} class="poster-image" width={290} height={386} loading="lazy" />}
              <div class="poster-scrim"></div>
              <div class="progressive-blur">
                <div class="blur-layer layer-1"></div>
                <div class="blur-layer layer-2"></div>
                <div class="blur-layer layer-3"></div>
                <div class="blur-layer layer-4"></div>
                <div class="blur-layer layer-5"></div>
                <div class="blur-layer layer-6"></div>
              </div>
              <div class="poster-info">
                <span class="poster-title">{toTitleCase(film.Movie)}</span>
                <span class="poster-meta">{[film.director, film.year].filter(Boolean).join(' \u00b7 ')}</span>
                <span class="poster-showtime">{showtimes.join(', ')}</span>
              </div>
            </a>
            );
          })}
        </div>
      </section>
    )}

    <section class="demos-section">
      <h2 class="section-heading">Demos</h2>
      <a href="/demo" class="demo-link">
        <span class="demo-title">Component Demos</span>
        <span class="demo-description">UI components, animations, and testing tools</span>
      </a>
    </section>
  </main>

  <!-- Series config + poster map for client-side live updates -->
  <script id="series-config" type="application/json" set:html={JSON.stringify({
    series: activeSeries.map(s => ({ id: s.id, dataFile: s.dataFile })),
    posterMap: posterUrlMap,
  })} />

  <script>
    function toTitleCase(str: string): string {
      return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function escapeHtml(text: string): string {
      const el = document.createElement('span');
      el.textContent = text;
      return el.innerHTML;
    }

    interface MovieEntry {
      Movie: string; Time: string; Datetime: string;
      director?: string; year?: string; poster_url?: string;
    }

    interface PosterMeta { src: string; width: number; height: number; }

    interface Config {
      series: { id: string; dataFile: string }[];
      posterMap: Record<string, PosterMeta>;
    }

    async function updateShowingToday() {
      const scrollEl = document.getElementById('today-scroll');
      if (!scrollEl) return;

      const buildDate = scrollEl.dataset.buildDate || '';
      const todayStr = new Date().toISOString().split('T')[0];

      // If browser date matches build date, the server render is already correct
      if (buildDate === todayStr) return;

      const configEl = document.getElementById('series-config');
      if (!configEl?.textContent) return;
      const config: Config = JSON.parse(configEl.textContent);

      const films: { film: MovieEntry; seriesId: string; showtimes: string[] }[] = [];

      for (const series of config.series) {
        try {
          const res = await fetch(series.dataFile);
          if (!res.ok) continue;
          const data: MovieEntry[] = await res.json();

          const allDates = [...new Set(data.map(m => m.Datetime.split('T')[0]))].sort();
          const targetDate = allDates.find(d => d >= todayStr) || allDates[0];

          const dayMovies = data.filter(m => m.Datetime.split('T')[0] === targetDate);

          const movieMap = new Map<string, typeof films[number]>();
          for (const m of dayMovies) {
            if (!m.poster_url) continue;
            if (movieMap.has(m.Movie)) {
              movieMap.get(m.Movie)!.showtimes.push(m.Time);
            } else {
              movieMap.set(m.Movie, { film: m, seriesId: series.id, showtimes: [m.Time] });
            }
          }
          films.push(...movieMap.values());
        } catch (e) {
          console.error(`Error loading series ${series.id}:`, e);
        }
      }

      if (films.length === 0) {
        scrollEl.innerHTML = '<p style="white-space:nowrap;color:var(--text-secondary);">No films showing today</p>';
        return;
      }

      scrollEl.innerHTML = films.map(({ film, seriesId, showtimes }) => {
        const pm = film.poster_url ? config.posterMap[film.poster_url] : null;
        const img = pm
          ? `<img src="${escapeHtml(pm.src)}" alt="${escapeHtml(film.Movie)}" class="poster-image" loading="lazy" width="${pm.width}" height="${pm.height}" />`
          : '';
        const title = escapeHtml(toTitleCase(film.Movie));
        const meta = [film.director, film.year].filter(Boolean).join(' \u00b7 ');
        const times = escapeHtml(showtimes.join(', '));

        return `<a href="/s/${escapeHtml(seriesId)}/calendar" class="poster-card">
          ${img}
          <div class="poster-scrim"></div>
          <div class="progressive-blur">
            <div class="blur-layer layer-1"></div>
            <div class="blur-layer layer-2"></div>
            <div class="blur-layer layer-3"></div>
            <div class="blur-layer layer-4"></div>
            <div class="blur-layer layer-5"></div>
            <div class="blur-layer layer-6"></div>
          </div>
          <div class="poster-info">
            <span class="poster-title">${title}</span>
            ${meta ? `<span class="poster-meta">${escapeHtml(meta)}</span>` : ''}
            <span class="poster-showtime">${times}</span>
          </div>
        </a>`;
      }).join('');

      // Update the build-date so subsequent checks skip re-rendering
      scrollEl.dataset.buildDate = todayStr;
    }

    updateShowingToday();
    document.addEventListener('visibilitychange', () => { if (!document.hidden) updateShowingToday(); });
    setInterval(updateShowingToday, 5 * 60 * 1000);
  </script>
</Layout>

<style>
  .landing {
    max-width: 720px;
    margin: 0 auto;
    padding: 40px 20px;
    text-align: center;
  }

  .site-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 700;
    font-size: 2.4rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-primary);
    margin-bottom: 12px;
  }

  .site-blurb {
    color: var(--text-secondary);
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 40px;
  }

  .ff-link {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .section-heading {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 500;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-tertiary);
    margin-bottom: 16px;
  }

  /* Demos section */
  .demos-section {
    margin-top: 48px;
    padding-bottom: 48px;
  }

  .demo-link {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 20px 24px;
    border-radius: 10px;
    background: var(--bg-day-movies);
    border: 1px solid var(--bg-grid);
    text-decoration: none;
    transition: background 0.2s, border-color 0.2s;
  }

  .demo-link:hover {
    background: var(--bg-movie-hover);
    border-color: var(--accent);
  }

  .demo-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .demo-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  /* Series cards */
  .series-cards {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 48px;
  }

  .series-card {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 20px 24px;
    border-radius: 10px;
    background: var(--bg-day-movies);
    border: 1px solid var(--bg-grid);
    text-decoration: none;
    transition: background 0.15s, border-color 0.15s;
  }

  .series-card:hover {
    background: var(--bg-movie-hover);
    border-color: var(--accent);
  }

  .series-name {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    color: var(--text-primary);
  }

  .series-subtitle {
    font-size: 0.95rem;
    color: var(--text-secondary);
  }

  .series-meta {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    margin-top: 4px;
  }

  /* Today gallery */
  .today-section {
    margin-top: 0;
  }
</style>

<!-- Global styles: these must apply to client-rendered poster cards too -->
<style is:global>
  .today-scroll {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
    /* Bleed to viewport edges for a full-width scroll feel */
    margin-left: -20px;
    margin-right: -20px;
    padding-left: 20px;
    padding-right: 20px;
  }

  /* Hide scrollbar but keep scroll functional */
  .today-scroll::-webkit-scrollbar {
    display: none;
  }
  .today-scroll {
    scrollbar-width: none;
  }

  .today-scroll .poster-card {
    position: relative;
    aspect-ratio: 3 / 4;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-movie);
    text-decoration: none;
    display: block;
    transition: transform 0.15s, box-shadow 0.15s;
    /* Fixed width so cards don't squish in the flex row */
    flex: 0 0 140px;
    scroll-snap-align: start;
  }

  @media (min-width: 480px) {
    .today-scroll .poster-card {
      flex: 0 0 155px;
    }
  }

  .today-scroll .poster-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  }

  .today-scroll .poster-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .today-scroll .poster-scrim {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60%;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.75) 0%,
      rgba(0, 0, 0, 0.35) 40%,
      transparent 100%
    );
    pointer-events: none;
  }

  .today-scroll .progressive-blur {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 45%;
    pointer-events: none;
  }

  .today-scroll .blur-layer {
    position: absolute;
    inset: 0;
  }

  .today-scroll .layer-1 {
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
    mask-image: linear-gradient(to top, transparent 50%, black 75%, black 100%);
    -webkit-mask-image: linear-gradient(to top, transparent 50%, black 75%, black 100%);
  }
  .today-scroll .layer-2 {
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    mask-image: linear-gradient(to top, transparent 35%, black 55%, black 80%, transparent 100%);
    -webkit-mask-image: linear-gradient(to top, transparent 35%, black 55%, black 80%, transparent 100%);
  }
  .today-scroll .layer-3 {
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
    mask-image: linear-gradient(to top, transparent 20%, black 40%, black 65%, transparent 85%);
    -webkit-mask-image: linear-gradient(to top, transparent 20%, black 40%, black 65%, transparent 85%);
  }
  .today-scroll .layer-4 {
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    mask-image: linear-gradient(to top, transparent 8%, black 25%, black 50%, transparent 70%);
    -webkit-mask-image: linear-gradient(to top, transparent 8%, black 25%, black 50%, transparent 70%);
  }
  .today-scroll .layer-5 {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    mask-image: linear-gradient(to top, transparent 0%, black 12%, black 35%, transparent 55%);
    -webkit-mask-image: linear-gradient(to top, transparent 0%, black 12%, black 35%, transparent 55%);
  }
  .today-scroll .layer-6 {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    mask-image: linear-gradient(to top, black 0%, black 15%, transparent 40%);
    -webkit-mask-image: linear-gradient(to top, black 0%, black 15%, transparent 40%);
  }

  .today-scroll .poster-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .today-scroll .poster-title {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    color: white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    line-height: 1.2;
  }

  .today-scroll .poster-meta {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
  }

  .today-scroll .poster-showtime {
    font-size: 0.7rem;
    color: var(--accent);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    font-weight: 500;
    margin-top: 1px;
  }
</style>
