---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Progressive Blur Demo">
  <h1>Progressive Blur</h1>
  <p class="subtitle">7-layer stacked blur with true intensity fade (Apple-style)</p>

  <div class="demo-controls">
    <div class="layer-toggles">
      <span class="control-label">Layers:</span>
      <div class="layer-buttons">
        <label class="layer-toggle">
          <input type="checkbox" data-layer="1" checked />
          <span>1px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="2" checked />
          <span>2px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="3" checked />
          <span>4px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="4" checked />
          <span>8px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="5" checked />
          <span>16px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="6" checked />
          <span>32px</span>
        </label>
        <label class="layer-toggle">
          <input type="checkbox" data-layer="7" checked />
          <span>64px</span>
        </label>
      </div>
    </div>
    <button class="toggle-all-btn" id="toggle-all">Toggle All</button>
  </div>

  <div class="demo-container">
    <div class="poster-card">
      <img src="/posters/taxi-driver.png" alt="Taxi Driver poster" class="poster-image" />
      <div class="progressive-blur">
        <div class="blur-layer layer-1" data-layer="1"></div>
        <div class="blur-layer layer-2" data-layer="2"></div>
        <div class="blur-layer layer-3" data-layer="3"></div>
        <div class="blur-layer layer-4" data-layer="4"></div>
        <div class="blur-layer layer-5" data-layer="5"></div>
        <div class="blur-layer layer-6" data-layer="6"></div>
        <div class="blur-layer layer-7" data-layer="7"></div>
      </div>
      <div class="text-overlay">
        <h3>Taxi Driver</h3>
        <p>Martin Scorsese • 1976</p>
        <p class="description">A mentally unstable veteran works as a nighttime taxi driver in New York City, where the perceived decadence and sleaze fuels his urge for violent action.</p>
      </div>
    </div>

    <div class="layer-visualization">
      <h3>Layer masks</h3>
      <div class="mask-preview">
        <div class="mask-bar layer-1" data-layer="1"><span>1px</span></div>
        <div class="mask-bar layer-2" data-layer="2"><span>2px</span></div>
        <div class="mask-bar layer-3" data-layer="3"><span>4px</span></div>
        <div class="mask-bar layer-4" data-layer="4"><span>8px</span></div>
        <div class="mask-bar layer-5" data-layer="5"><span>16px</span></div>
        <div class="mask-bar layer-6" data-layer="6"><span>32px</span></div>
        <div class="mask-bar layer-7" data-layer="7"><span>64px</span></div>
      </div>
      <div class="mask-labels">
        <span>0%</span>
        <span>100%</span>
      </div>
    </div>
  </div>

  <div class="comparison-section">
    <h2>Comparison</h2>
    <div class="comparison-grid">
      <div class="comparison-card">
        <div class="poster-card small">
          <img src="/posters/mean-streets.png" alt="Mean Streets poster" class="poster-image" />
          <div class="simple-blur-layer"></div>
          <div class="text-overlay small">
            <h3>Mean Streets</h3>
            <p>Scorsese • 1973</p>
          </div>
        </div>
        <span class="comparison-label">Simple (single layer)</span>
      </div>
      <div class="comparison-card">
        <div class="poster-card small">
          <img src="/posters/mean-streets.png" alt="Mean Streets poster" class="poster-image" />
          <div class="progressive-blur">
            <div class="blur-layer layer-1"></div>
            <div class="blur-layer layer-2"></div>
            <div class="blur-layer layer-3"></div>
            <div class="blur-layer layer-4"></div>
            <div class="blur-layer layer-5"></div>
            <div class="blur-layer layer-6"></div>
            <div class="blur-layer layer-7"></div>
          </div>
          <div class="text-overlay small">
            <h3>Mean Streets</h3>
            <p>Scorsese • 1973</p>
          </div>
        </div>
        <span class="comparison-label">Progressive (7 layers)</span>
      </div>
    </div>
  </div>

  <div class="info-section">
    <h2>How it works</h2>
    <p>Seven blur layers are stacked, each with increasing blur values (1px → 2px → 4px → 8px → 16px → 32px → 64px). Each layer is masked to cover a different vertical region with ~7% overlap, creating a smooth progression from sharp to heavily blurred.</p>
    <pre><code>/* Layer 1 (lightest) at top, Layer 7 (heaviest) at bottom */
.layer-1 {'{'} backdrop-filter: blur(1px);  mask: linear-gradient(to top, transparent 79%, black 86%, black 93%, transparent 100%); {'}'}
.layer-2 {'{'} backdrop-filter: blur(2px);  mask: linear-gradient(to top, transparent 65%, black 72%, black 79%, transparent 86%); {'}'}
.layer-3 {'{'} backdrop-filter: blur(4px);  mask: linear-gradient(to top, transparent 51%, black 58%, black 65%, transparent 72%); {'}'}
.layer-4 {'{'} backdrop-filter: blur(8px);  mask: linear-gradient(to top, transparent 36%, black 43%, black 51%, transparent 58%); {'}'}
.layer-5 {'{'} backdrop-filter: blur(16px); mask: linear-gradient(to top, transparent 22%, black 29%, black 36%, transparent 43%); {'}'}
.layer-6 {'{'} backdrop-filter: blur(32px); mask: linear-gradient(to top, transparent 8%, black 15%, black 22%, transparent 29%); {'}'}
.layer-7 {'{'} backdrop-filter: blur(64px); mask: linear-gradient(to top, black 0%, black 8%, transparent 15%); {'}'}</code></pre>
    <p class="note"><strong>Trade-off:</strong> More DOM elements and potential performance impact, but creates a much smoother, more natural blur gradient than single-layer approaches.</p>
  </div>
</Layout>

<script>
  const params = new URLSearchParams(window.location.search);
  const layerToggles = document.querySelectorAll('.layer-toggle input');
  const blurLayers = document.querySelectorAll('.poster-card:first-of-type .blur-layer');
  const maskBars = document.querySelectorAll('.mask-bar');
  const toggleAllBtn = document.getElementById('toggle-all');

  // Layer toggle functionality
  layerToggles.forEach(toggle => {
    toggle.addEventListener('change', (e) => {
      const input = e.target as HTMLInputElement;
      const layerNum = input.dataset.layer;
      const isChecked = input.checked;

      // Update blur layer visibility
      blurLayers.forEach(layer => {
        if ((layer as HTMLElement).dataset.layer === layerNum) {
          (layer as HTMLElement).style.opacity = isChecked ? '1' : '0';
        }
      });

      // Update mask bar visibility
      maskBars.forEach(bar => {
        if ((bar as HTMLElement).dataset.layer === layerNum) {
          (bar as HTMLElement).style.opacity = isChecked ? '1' : '0.2';
        }
      });

      updateURL();
    });
  });

  let allOn = true;
  toggleAllBtn?.addEventListener('click', () => {
    allOn = !allOn;
    layerToggles.forEach(toggle => {
      (toggle as HTMLInputElement).checked = allOn;
      toggle.dispatchEvent(new Event('change'));
    });
  });

  // URL management
  function updateURL() {
    const newParams = new URLSearchParams(window.location.search);

    for (let i = 1; i <= 7; i++) {
      const toggle = document.querySelector(`input[data-layer="${i}"]`) as HTMLInputElement;
      if (toggle && !toggle.checked) {
        newParams.set(`layer${i}`, '0');
      } else {
        newParams.delete(`layer${i}`);
      }
    }

    const newURL = newParams.toString()
      ? `${window.location.pathname}?${newParams}`
      : window.location.pathname;
    history.replaceState({}, '', newURL);
  }

  // Initialize on load
  window.addEventListener('load', () => {
    // Restore layer toggles from URL
    for (let i = 1; i <= 7; i++) {
      if (params.get(`layer${i}`) === '0') {
        const toggle = document.querySelector(`input[data-layer="${i}"]`) as HTMLInputElement;
        if (toggle) {
          toggle.checked = false;
          toggle.dispatchEvent(new Event('change'));
        }
      }
    }
  });
</script>

<style>
  h1 {
    margin-top: 20px;
  }

  .demo-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    justify-content: center;
    align-items: center;
    margin-bottom: 32px;
    padding: 16px;
    background: var(--bg-movie);
    border-radius: 8px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  .layer-toggles {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .control-label {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .layer-buttons {
    display: flex;
    gap: 4px;
  }

  .layer-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    font-size: 12px;
    font-family: monospace;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .layer-toggle:has(input:checked) {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .layer-toggle input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .toggle-all-btn {
    padding: 6px 12px;
    font-size: 13px;
    background: var(--bg-movie-hover);
    border: 1px solid var(--bg-movie-hover);
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
  }

  .toggle-all-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .demo-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 32px;
    padding: 32px 16px;
    flex-wrap: wrap;
  }

  .poster-card {
    position: relative;
    width: 300px;
    height: 450px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }

  .poster-card.small {
    width: 200px;
    height: 300px;
  }

  .poster-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .progressive-blur {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100%;
    pointer-events: none;
  }

  .blur-layer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100%;
    transition: opacity 0.2s;
  }

  /* 7 layers with doubling blur values: 1, 2, 4, 8, 16, 32, 64 */
  /* Blur increases toward BOTTOM where text overlay lives */
  /* Layer 1 (lightest) at top of blur zone, Layer 7 (heaviest) at bottom */
  /* Explicit z-index to ensure proper stacking */

  .layer-1 {
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
    mask-image: linear-gradient(to top, transparent 79%, black 86%, black 93%, transparent 100%);
    -webkit-mask-image: linear-gradient(to top, transparent 79%, black 86%, black 93%, transparent 100%);
    z-index: 1;
  }

  .layer-2 {
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    mask-image: linear-gradient(to top, transparent 65%, black 72%, black 79%, transparent 86%);
    -webkit-mask-image: linear-gradient(to top, transparent 65%, black 72%, black 79%, transparent 86%);
    z-index: 2;
  }

  .layer-3 {
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    mask-image: linear-gradient(to top, transparent 51%, black 58%, black 65%, transparent 72%);
    -webkit-mask-image: linear-gradient(to top, transparent 51%, black 58%, black 65%, transparent 72%);
    z-index: 3;
  }

  .layer-4 {
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    mask-image: linear-gradient(to top, transparent 36%, black 43%, black 51%, transparent 58%);
    -webkit-mask-image: linear-gradient(to top, transparent 36%, black 43%, black 51%, transparent 58%);
    z-index: 4;
  }

  .layer-5 {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    mask-image: linear-gradient(to top, transparent 22%, black 29%, black 36%, transparent 43%);
    -webkit-mask-image: linear-gradient(to top, transparent 22%, black 29%, black 36%, transparent 43%);
    z-index: 5;
  }

  .layer-6 {
    backdrop-filter: blur(32px);
    -webkit-backdrop-filter: blur(32px);
    mask-image: linear-gradient(to top, transparent 8%, black 15%, black 22%, transparent 29%);
    -webkit-mask-image: linear-gradient(to top, transparent 8%, black 15%, black 22%, transparent 29%);
    z-index: 6;
  }

  .layer-7 {
    backdrop-filter: blur(64px);
    -webkit-backdrop-filter: blur(64px);
    mask-image: linear-gradient(to top, black 0%, black 8%, transparent 15%);
    -webkit-mask-image: linear-gradient(to top, black 0%, black 8%, transparent 15%);
    z-index: 7;
  }

  .text-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    color: white;
  }

  .text-overlay.small {
    padding: 12px;
  }

  .text-overlay h3 {
    margin: 0 0 4px 0;
    font-size: 24px;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .text-overlay.small h3 {
    font-size: 18px;
  }

  .text-overlay p {
    margin: 0;
    font-size: 14px;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .text-overlay.small p {
    font-size: 12px;
  }

  .text-overlay .description {
    margin-top: 8px;
    font-size: 13px;
    line-height: 1.4;
    color: rgba(255, 255, 255, 0.75);
  }

  /* Layer visualization */
  .layer-visualization {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .layer-visualization h3 {
    margin: 0;
    font-size: 14px;
    color: var(--text-secondary);
  }

  .mask-preview {
    width: 120px;
    height: 450px;
    background: var(--bg-movie);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
  }

  .mask-bar {
    position: absolute;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }

  .mask-bar span {
    font-size: 11px;
    font-family: monospace;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  /* Position each bar to show its zone - 7 layers spanning 450px */
  /* Layer 7 at bottom (heaviest blur), Layer 1 at top (lightest) */
  .mask-bar.layer-7 { bottom: 0; height: 64px; background: hsl(80, 70%, 25%); }
  .mask-bar.layer-6 { bottom: 64px; height: 64px; background: hsl(100, 70%, 28%); }
  .mask-bar.layer-5 { bottom: 128px; height: 64px; background: hsl(120, 70%, 30%); }
  .mask-bar.layer-4 { bottom: 192px; height: 64px; background: hsl(140, 70%, 35%); }
  .mask-bar.layer-3 { bottom: 256px; height: 64px; background: hsl(160, 70%, 40%); }
  .mask-bar.layer-2 { bottom: 320px; height: 64px; background: hsl(180, 70%, 45%); }
  .mask-bar.layer-1 { bottom: 384px; height: 66px; background: hsl(200, 70%, 50%); }

  .mask-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-tertiary);
    font-family: monospace;
  }

  /* Comparison section */
  .comparison-section {
    max-width: 600px;
    margin: 32px auto;
    padding: 0 16px;
  }

  .comparison-section h2 {
    margin: 0 0 16px 0;
    font-size: 18px;
    color: var(--text-primary);
  }

  .comparison-grid {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .comparison-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .comparison-label {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Simple blur for comparison */
  .simple-blur-layer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100%;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    mask-image: linear-gradient(to top, black 15%, transparent 50%);
    -webkit-mask-image: linear-gradient(to top, black 15%, transparent 50%);
    pointer-events: none;
  }

  /* Info section */
  .info-section {
    max-width: 600px;
    margin: 32px auto;
    padding: 24px;
    background: var(--bg-movie);
    border-radius: 8px;
  }

  .info-section h2 {
    margin: 0 0 12px 0;
    font-size: 18px;
    color: var(--text-primary);
  }

  .info-section p {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .info-section pre {
    background: var(--bg-movie-hover);
    padding: 12px 16px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 12px 0;
  }

  .info-section pre code {
    font-size: 11px;
    line-height: 1.5;
    color: var(--text-primary);
  }

  .note {
    background: rgba(100, 150, 255, 0.1);
    border-left: 3px solid rgba(100, 150, 255, 0.5);
    padding: 12px;
    border-radius: 0 6px 6px 0;
    margin-top: 16px;
  }
</style>
