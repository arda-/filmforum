---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Card Flip" noindex={true}>
  <div class="demo-container">
    <p class="version">v6</p>
    <h1>Card Flip (FLIP Animation)</h1>
    <p class="subtitle">Demonstrating the FLIP technique for smooth CSS animations</p>

    <div class="grid">
      {[
        { id: 5, title: 'Growing Radius', desc: '1rem → 2rem border-radius' },
        { id: 4, title: 'Same Element', desc: 'Card itself expands' },
        { id: 3, title: 'FLIP + Smooth Close', desc: 'Smooth open and close' },
        { id: 2, title: 'FLIP Animation', desc: 'Smooth transform-based expansion' },
        { id: 1, title: 'Original', desc: 'Base card style' },
      ].map((card) => (
        <div class="card" data-id={card.id}>
          <div class="card-content">
            <div class="card-number">{card.id}</div>
            <div class="card-title">{card.title}</div>
            <div class="card-desc">{card.desc}</div>
          </div>
        </div>
      ))}
    </div>

    <div class="expanded-card" id="expandedCard">
      <button class="close-btn" id="closeBtn">×</button>
      <div class="expanded-content">
        <span class="expanded-label" id="expandedLabel"></span>
      </div>
    </div>
  </div>
</Layout>

<script>
  const cards = document.querySelectorAll('.card');
  const expandedCard = document.getElementById('expandedCard');
  const expandedLabel = document.getElementById('expandedLabel');
  const closeBtn = document.getElementById('closeBtn');

  let sourceCard = null;
  let sourceCardId = 0;
  let placeholder = null;
  let justOpened = false;

  function flipOpen(element) {
    const first = element.getBoundingClientRect();

    expandedCard.classList.add('active');
    document.body.style.overflow = 'hidden';

    const last = expandedCard.getBoundingClientRect();

    const deltaX = first.left - last.left;
    const deltaY = first.top - last.top;
    const deltaWidth = first.width / last.width;
    const deltaHeight = first.height / last.height;

    expandedCard.style.transformOrigin = '0 0';
    expandedCard.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${deltaWidth}, ${deltaHeight})`;
    expandedCard.style.transition = 'none';
    expandedCard.offsetHeight;

    expandedCard.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    expandedCard.style.transform = 'translate(0, 0) scale(1, 1)';
  }

  function sameElementOpen(card) {
    // Measure the card in its grid position
    const first = card.getBoundingClientRect();

    // Insert placeholder to hold grid space
    placeholder = document.createElement('div');
    placeholder.style.width = first.width + 'px';
    placeholder.style.height = first.height + 'px';
    card.parentNode.insertBefore(placeholder, card);

    // Make the card fixed and expanded
    card.classList.add('card-expanded');
    document.body.style.overflow = 'hidden';

    const last = card.getBoundingClientRect();

    const deltaX = first.left - last.left;
    const deltaY = first.top - last.top;
    const scaleX = first.width / last.width;
    const scaleY = first.height / last.height;

    card.style.transformOrigin = '0 0';
    card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
    card.style.borderRadius = `${1/scaleX}rem / ${1/scaleY}rem`;
    card.style.transition = 'none';
    card.offsetHeight;

    card.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), border-radius 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    card.style.transform = 'translate(0, 0) scale(1, 1)';
    card.style.borderRadius = '1rem';
  }

  function sameElementClose() {
    if (!sourceCard || !placeholder) return;
    const card = sourceCard;

    // Measure where placeholder is (the original grid position)
    const targetRect = placeholder.getBoundingClientRect();
    const currentRect = card.getBoundingClientRect();

    const deltaX = targetRect.left - currentRect.left;
    const deltaY = targetRect.top - currentRect.top;
    const scaleX = targetRect.width / currentRect.width;
    const scaleY = targetRect.height / currentRect.height;

    card.style.transformOrigin = '0 0';
    card.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), border-radius 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
    card.style.borderRadius = `${1/scaleX}rem / ${1/scaleY}rem`;

    card.addEventListener('transitionend', function handler(e) {
      if (e.propertyName !== 'transform') return;
      card.removeEventListener('transitionend', handler);
      card.classList.remove('card-expanded');
      card.style.transform = '';
      card.style.transition = '';
      card.style.transformOrigin = '';
      card.style.borderRadius = '';
      document.body.style.overflow = '';
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.insertBefore(card, placeholder);
        placeholder.remove();
      }
      placeholder = null;
      sourceCard = null;
    }, { once: false });
  }

  // === Card 5: Same-element expand with growing border-radius (1rem → 2rem) ===
  let placeholder5 = null;
  let justOpened5 = false;

  function card5Open(card) {
    const first = card.getBoundingClientRect();

    placeholder5 = document.createElement('div');
    placeholder5.style.width = first.width + 'px';
    placeholder5.style.height = first.height + 'px';
    card.parentNode.insertBefore(placeholder5, card);

    card.classList.add('card-expanded-5');
    document.body.style.overflow = 'hidden';

    const last = card.getBoundingClientRect();

    const deltaX = first.left - last.left;
    const deltaY = first.top - last.top;
    const scaleX = first.width / last.width;
    const scaleY = first.height / last.height;

    // At scale(scaleX, scaleY), border-radius R renders as R*scaleX / R*scaleY visually.
    // We want it to look like 1rem circular at start → set R so R*scale = 1rem.
    card.style.transformOrigin = '0 0';
    card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
    card.style.borderRadius = `${1/scaleX}rem / ${1/scaleY}rem`;
    card.style.transition = 'none';
    card.offsetHeight;

    // Animate to expanded: scale(1,1) with 2rem border-radius
    card.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), border-radius 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    card.style.transform = 'translate(0, 0) scale(1, 1)';
    card.style.borderRadius = '2rem';
  }

  function card5Close() {
    if (!sourceCard || !placeholder5) return;
    const card = sourceCard;

    const targetRect = placeholder5.getBoundingClientRect();
    const currentRect = card.getBoundingClientRect();

    const deltaX = targetRect.left - currentRect.left;
    const deltaY = targetRect.top - currentRect.top;
    const scaleX = targetRect.width / currentRect.width;
    const scaleY = targetRect.height / currentRect.height;

    card.style.transformOrigin = '0 0';
    card.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), border-radius 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
    card.style.borderRadius = `${1/scaleX}rem / ${1/scaleY}rem`;

    card.addEventListener('transitionend', function handler(e) {
      if (e.propertyName !== 'transform') return;
      card.removeEventListener('transitionend', handler);
      card.classList.remove('card-expanded-5');
      card.style.transform = '';
      card.style.transition = '';
      card.style.transformOrigin = '';
      card.style.borderRadius = '';
      document.body.style.overflow = '';
      if (placeholder5 && placeholder5.parentNode) {
        placeholder5.parentNode.insertBefore(card, placeholder5);
        placeholder5.remove();
      }
      placeholder5 = null;
      sourceCard = null;
    }, { once: false });
  }

  function closeInstant() {
    expandedCard.classList.remove('active');
    document.body.style.overflow = '';
    expandedCard.style.transform = '';
    expandedCard.style.transition = '';
    sourceCard = null;
  }

  function closeSmoothFlip() {
    if (!sourceCard) { closeInstant(); return; }

    const expandedRect = expandedCard.getBoundingClientRect();
    const targetRect = sourceCard.getBoundingClientRect();

    const deltaX = targetRect.left - expandedRect.left;
    const deltaY = targetRect.top - expandedRect.top;
    const scaleX = targetRect.width / expandedRect.width;
    const scaleY = targetRect.height / expandedRect.height;

    expandedCard.style.transformOrigin = '0 0';
    expandedCard.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    expandedCard.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;

    expandedCard.addEventListener('transitionend', function handler(e) {
      if (e.propertyName !== 'transform') return;
      expandedCard.removeEventListener('transitionend', handler);
      expandedCard.classList.remove('active');
      document.body.style.overflow = '';
      expandedCard.style.transform = '';
      expandedCard.style.transition = '';
      expandedCard.style.transformOrigin = '';
      sourceCard = null;
    }, { once: false });
  }

  function handleClose() {
    if (sourceCardId === 5) {
      card5Close();
    } else if (sourceCardId === 4) {
      sameElementClose();
    } else if (sourceCardId === 3) {
      closeSmoothFlip();
    } else {
      closeInstant();
    }
  }

  cards.forEach((card) => {
    card.addEventListener('click', () => {
      if (card.classList.contains('card-expanded')) return;
      const id = parseInt(card.dataset.id, 10);
      sourceCard = card;
      sourceCardId = id;

      if (id === 5) {
        justOpened5 = true;
        card5Open(card);
      } else if (id === 4) {
        justOpened = true;
        sameElementOpen(card);
      } else {
        expandedLabel.textContent = card.querySelector('.card-number').textContent;
        if (id >= 2) {
          flipOpen(card);
        } else {
          expandedCard.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
    });
  });

  closeBtn.addEventListener('click', handleClose);

  // Close card 5 by clicking on it when expanded
  document.addEventListener('click', (e) => {
    if (justOpened5) { justOpened5 = false; return; }
    if (sourceCardId === 5 && sourceCard && sourceCard.classList.contains('card-expanded-5')) {
      if (sourceCard.contains(e.target)) {
        card5Close();
      }
    }
  });

  // Close card 4 by clicking on it when expanded
  document.addEventListener('click', (e) => {
    if (justOpened) { justOpened = false; return; }
    if (sourceCardId === 4 && sourceCard && sourceCard.classList.contains('card-expanded')) {
      if (sourceCard.contains(e.target)) {
        sameElementClose();
      }
    }
  });
</script>

<style>
  .demo-container {
    margin: 0 auto;
    padding: 40px 20px;
  }

  .version {
    font-size: 12px;
    color: var(--text-tertiary);
    margin: 0 0 4px;
  }

  h1 {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .subtitle {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 48px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .card {
    aspect-ratio: 1;
    background: var(--bg-movie);
    border-radius: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-align: center;
    padding: 20px;
  }

  .card-number {
    font-size: 36px;
    font-weight: 700;
    color: var(--accent);
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-desc {
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .card.card-expanded,
  .card.card-expanded-5 {
    position: fixed;
    inset: 0;
    margin: auto;
    width: 100%;
    height: 85dvh;
    max-width: calc(100% - 40px);
    aspect-ratio: auto;
    z-index: 1000;
    cursor: default;
  }

  .card.card-expanded-5 {
    border-radius: 2rem;
  }

  .expanded-card {
    position: fixed;
    inset: 0;
    margin: auto;
    width: 100%;
    height: 85dvh;
    max-width: calc(100% - 40px);
    background: var(--bg-movie);
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
    visibility: hidden;
    z-index: 1000;
  }

  .expanded-card.active {
    visibility: visible;
  }

  .close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-body);
    color: var(--text-primary);
    border-radius: 50%;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .expanded-content {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .expanded-label {
    font-size: 72px;
    font-weight: 700;
    color: var(--accent);
  }

</style>
