---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Card Flip" noindex={true}>
  <div class="demo-container">
    <p class="version">v9</p>
    <h1>Card Flip (FLIP Animation)</h1>
    <p class="subtitle">Demonstrating the FLIP technique for smooth CSS animations</p>

    <div class="grid">
      {[
        { id: 7, title: 'With Close Btn', desc: '1rem → 2rem + close button' },
        { id: 6, title: 'Growing Radius B', desc: '1rem → 2rem (factory)' },
        { id: 5, title: 'Growing Radius', desc: '1rem → 2rem (factory)' },
        { id: 4, title: 'Same Element', desc: '1rem → 1rem (factory)' },
        { id: 3, title: 'FLIP + Smooth Close', desc: 'Smooth open and close' },
        { id: 2, title: 'FLIP Animation', desc: 'Smooth transform-based expansion' },
        { id: 1, title: 'Original', desc: 'Base card style' },
      ].map((card) => (
        <div class="card" data-id={card.id}>
          <div class="card-content">
            <div class="card-number">{card.id}</div>
            <div class="card-title">{card.title}</div>
            <div class="card-desc">{card.desc}</div>
          </div>
        </div>
      ))}
    </div>

    <div class="expanded-card" id="expandedCard">
      <button class="close-btn" id="closeBtn">×</button>
      <div class="expanded-content">
        <span class="expanded-label" id="expandedLabel"></span>
      </div>
    </div>
  </div>
</Layout>

<script>
  const cards = document.querySelectorAll('.card');
  const expandedCard = document.getElementById('expandedCard');
  const expandedLabel = document.getElementById('expandedLabel');
  const closeBtn = document.getElementById('closeBtn');

  const EASING = 'cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  const DURATION = '0.6s';
  const EXPANDED_CLASS = 'card-se-expanded';

  let sourceCard = null;
  let sourceCardId = 0;

  // === Same-element expander factory ===
  function createExpander({
    closedRadius = 1,
    openRadius = 1,
    width = '100%',
    height = '85dvh',
    maxWidth = 'calc(100% - 40px)',
    maxHeight = 'none',
    showCloseBtn = false,
  } = {}) {
    let placeholder = null;
    let justOpened = false;
    let closeBtnEl = null;

    function open(card) {
      const first = card.getBoundingClientRect();

      placeholder = document.createElement('div');
      placeholder.style.width = first.width + 'px';
      placeholder.style.height = first.height + 'px';
      card.parentNode.insertBefore(placeholder, card);

      card.classList.add(EXPANDED_CLASS);
      card.style.width = width;
      card.style.height = height;
      card.style.maxWidth = maxWidth;
      card.style.maxHeight = maxHeight;
      document.body.style.overflow = 'hidden';

      const last = card.getBoundingClientRect();
      const deltaX = first.left - last.left;
      const deltaY = first.top - last.top;
      const scaleX = first.width / last.width;
      const scaleY = first.height / last.height;

      // Counter-scale border-radius so it looks like closedRadius visually at scale
      card.style.transformOrigin = '0 0';
      card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
      card.style.borderRadius = `${closedRadius / scaleX}rem / ${closedRadius / scaleY}rem`;
      card.style.transition = 'none';
      card.offsetHeight;

      card.style.transition = `transform ${DURATION} ${EASING}, border-radius ${DURATION} ${EASING}`;
      card.style.transform = 'translate(0, 0) scale(1, 1)';
      card.style.borderRadius = `${openRadius}rem`;
      justOpened = true;

      if (showCloseBtn) {
        closeBtnEl = document.createElement('button');
        closeBtnEl.className = 'close-btn';
        closeBtnEl.textContent = '\u00d7';
        closeBtnEl.addEventListener('click', (e) => {
          e.stopPropagation();
          close();
        });
        card.appendChild(closeBtnEl);
      }
    }

    function close() {
      if (!sourceCard || !placeholder) return;
      const card = sourceCard;

      const targetRect = placeholder.getBoundingClientRect();
      const currentRect = card.getBoundingClientRect();
      const deltaX = targetRect.left - currentRect.left;
      const deltaY = targetRect.top - currentRect.top;
      const scaleX = targetRect.width / currentRect.width;
      const scaleY = targetRect.height / currentRect.height;

      card.style.transformOrigin = '0 0';
      card.style.transition = `transform ${DURATION} ${EASING}, border-radius ${DURATION} ${EASING}`;
      card.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
      card.style.borderRadius = `${closedRadius / scaleX}rem / ${closedRadius / scaleY}rem`;

      card.addEventListener('transitionend', function handler(e) {
        if (e.propertyName !== 'transform') return;
        card.removeEventListener('transitionend', handler);
        card.classList.remove(EXPANDED_CLASS);
        card.style.transform = '';
        card.style.transition = '';
        card.style.transformOrigin = '';
        card.style.borderRadius = '';
        card.style.width = '';
        card.style.height = '';
        card.style.maxWidth = '';
        card.style.maxHeight = '';
        if (closeBtnEl) { closeBtnEl.remove(); closeBtnEl = null; }
        document.body.style.overflow = '';
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.insertBefore(card, placeholder);
          placeholder.remove();
        }
        placeholder = null;
        sourceCard = null;
      }, { once: false });
    }

    return {
      open,
      close,
      get justOpened() { return justOpened; },
      set justOpened(v) { justOpened = v; },
    };
  }

  // === Expander instances (one per same-element card) ===
  const expanders = {
    4: createExpander({ closedRadius: 1, openRadius: 1 }),
    5: createExpander({ closedRadius: 1, openRadius: 2 }),
    6: createExpander({ closedRadius: 1, openRadius: 2 }),
    7: createExpander({ closedRadius: 1, openRadius: 2, showCloseBtn: true }),
  };

  // === Cards 1-3: overlay-based (unchanged) ===
  function flipOpen(element) {
    const first = element.getBoundingClientRect();

    expandedCard.classList.add('active');
    document.body.style.overflow = 'hidden';

    const last = expandedCard.getBoundingClientRect();
    const deltaX = first.left - last.left;
    const deltaY = first.top - last.top;
    const deltaWidth = first.width / last.width;
    const deltaHeight = first.height / last.height;

    expandedCard.style.transformOrigin = '0 0';
    expandedCard.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${deltaWidth}, ${deltaHeight})`;
    expandedCard.style.transition = 'none';
    expandedCard.offsetHeight;

    expandedCard.style.transition = `transform ${DURATION} ${EASING}`;
    expandedCard.style.transform = 'translate(0, 0) scale(1, 1)';
  }

  function closeInstant() {
    expandedCard.classList.remove('active');
    document.body.style.overflow = '';
    expandedCard.style.transform = '';
    expandedCard.style.transition = '';
    sourceCard = null;
  }

  function closeSmoothFlip() {
    if (!sourceCard) { closeInstant(); return; }

    const expandedRect = expandedCard.getBoundingClientRect();
    const targetRect = sourceCard.getBoundingClientRect();
    const deltaX = targetRect.left - expandedRect.left;
    const deltaY = targetRect.top - expandedRect.top;
    const scaleX = targetRect.width / expandedRect.width;
    const scaleY = targetRect.height / expandedRect.height;

    expandedCard.style.transformOrigin = '0 0';
    expandedCard.style.transition = `transform ${DURATION} ${EASING}`;
    expandedCard.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;

    expandedCard.addEventListener('transitionend', function handler(e) {
      if (e.propertyName !== 'transform') return;
      expandedCard.removeEventListener('transitionend', handler);
      expandedCard.classList.remove('active');
      document.body.style.overflow = '';
      expandedCard.style.transform = '';
      expandedCard.style.transition = '';
      expandedCard.style.transformOrigin = '';
      sourceCard = null;
    }, { once: false });
  }

  // === Close dispatcher ===
  function handleClose() {
    if (expanders[sourceCardId]) {
      expanders[sourceCardId].close();
    } else if (sourceCardId === 3) {
      closeSmoothFlip();
    } else {
      closeInstant();
    }
  }

  // === Click to open ===
  cards.forEach((card) => {
    card.addEventListener('click', () => {
      if (card.classList.contains(EXPANDED_CLASS)) return;
      const id = parseInt(card.dataset.id, 10);
      sourceCard = card;
      sourceCardId = id;

      if (expanders[id]) {
        expanders[id].open(card);
      } else {
        expandedLabel.textContent = card.querySelector('.card-number').textContent;
        if (id >= 2) {
          flipOpen(card);
        } else {
          expandedCard.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
    });
  });

  closeBtn.addEventListener('click', handleClose);

  // === Click-to-close for same-element expanders ===
  document.addEventListener('click', (e) => {
    const exp = expanders[sourceCardId];
    if (!exp) return;
    if (exp.justOpened) { exp.justOpened = false; return; }
    if (sourceCard && sourceCard.classList.contains(EXPANDED_CLASS)) {
      if (sourceCard.contains(e.target)) {
        exp.close();
      }
    }
  });
</script>

<style>
  .demo-container {
    margin: 0 auto;
    padding: 40px 20px;
  }

  .version {
    font-size: 12px;
    color: var(--text-tertiary);
    margin: 0 0 4px;
  }

  h1 {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .subtitle {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 48px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .card {
    aspect-ratio: 1;
    background: var(--bg-movie);
    border-radius: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-align: center;
    padding: 20px;
  }

  .card-number {
    font-size: 36px;
    font-weight: 700;
    color: var(--accent);
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-desc {
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .card.card-se-expanded {
    position: fixed;
    inset: 0;
    margin: auto;
    aspect-ratio: auto;
    z-index: 1000;
    cursor: default;
  }

  .expanded-card {
    position: fixed;
    inset: 0;
    margin: auto;
    width: 100%;
    height: 85dvh;
    max-width: calc(100% - 40px);
    background: var(--bg-movie);
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
    visibility: hidden;
    z-index: 1000;
  }

  .expanded-card.active {
    visibility: visible;
  }

  .close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-body);
    color: var(--text-primary);
    border-radius: 50%;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .expanded-content {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .expanded-label {
    font-size: 72px;
    font-weight: 700;
    color: var(--accent);
  }

</style>
