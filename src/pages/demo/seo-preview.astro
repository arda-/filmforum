---
import Layout from '../../layouts/Layout.astro';
import { getSeriesConfig, getActiveSeries } from '../../config/series';

// Use first active series, fallback to hardcoded if no active series
const activeSeries = getActiveSeries();
const seriesId = activeSeries.length > 0 ? activeSeries[0].id : 'tenement-stories';
const series = getSeriesConfig(seriesId);

if (!series) {
  throw new Error(`SEO preview demo: Series "${seriesId}" not found. Add an active series to config/series.ts`);
}

// Load first movie poster
const fs = await import('node:fs');
const path = await import('node:path');
const dataPath = path.join(process.cwd(), 'public', series.dataFile);
const movieData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
const firstPoster = movieData[0]?.poster_url;

// Deduplicate movies by title to get unique film count
const filmMap = new Map();
for (const m of movieData) {
  if (!filmMap.has(m.Movie)) {
    filmMap.set(m.Movie, { ...m, showtimeCount: 1 });
  } else {
    filmMap.get(m.Movie).showtimeCount++;
  }
}
const films = Array.from(filmMap.values());

// Define all route types and their expected meta tags
const routes = [
  {
    name: 'Home Page',
    url: '/',
    title: 'FilmForum - Discover and Plan Your Film Series',
    description: 'Explore curated film series, browse showtimes, and plan your cinema visits. Interactive calendars and movie lists for film enthusiasts at Film Forum.',
    image: null,
    hasImage: false,
  },
  {
    name: 'Series Landing',
    url: `/s/${seriesId}/`,
    title: `${series.name}: ${series.subtitle} - Film Forum`,
    description: `Explore ${films.length} films in ${series.name}: ${series.subtitle} at ${series.venueName}, ${series.dateRange}. Browse the complete calendar and movie list.`,
    image: firstPoster,
    hasImage: true,
  },
  {
    name: 'Series Calendar',
    url: `/s/${seriesId}/calendar`,
    title: `${series.name} Calendar - ${series.venueName} Showtimes`,
    description: `Interactive calendar for ${series.name} at ${series.venueName}. Browse showtimes, filter by day, and plan your visits. ${series.dateRange}.`,
    image: firstPoster,
    hasImage: true,
  },
  {
    name: 'Movie List',
    url: `/s/${seriesId}/list`,
    title: `${series.name} Movie List - Browse Films`,
    description: `Browse all films in ${series.name}. Mark your favorites (Yes/Maybe/No), create a shareable list, and plan your ${series.venueName} visits.`,
    image: firstPoster,
    hasImage: true,
  },
  {
    name: 'Shared List',
    url: `/s/${seriesId}/list/saved`,
    title: `Shared List - ${series.name} Recommendations`,
    description: `Check out this curated list of films from ${series.name} at ${series.venueName}. See what your friend recommends!`,
    image: null,
    hasImage: false,
  },
  {
    name: 'Compare Lists',
    url: `/s/${seriesId}/compare/placeholder`,
    title: `Compare Lists - ${series.name}`,
    description: `Compare two movie lists from ${series.name}. Find overlaps, disagreements, and plan your cinema visits together.`,
    image: null,
    hasImage: false,
  },
];

const siteUrl = Astro.site?.toString().replace(/\/$/, '') || Astro.url.origin;
const siteName = new URL(siteUrl).host;
---

<Layout title="SEO Preview - OpenGraph Share Examples" noindex={true}>
  <style>
    .seo-preview {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .header {
      margin-bottom: 3rem;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .routes-grid {
      display: grid;
      gap: 2rem;
    }

    .route-card {
      background: var(--bg-movie);
      border: 1px solid var(--bg-grid);
      border-radius: 8px;
      overflow: hidden;
    }

    .route-header {
      padding: 1rem 1.5rem;
      background: var(--bg-body);
      border-bottom: 1px solid var(--bg-grid);
    }

    .route-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .route-url {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      font-family: 'Courier New', monospace;
    }

    .og-card {
      margin: 1.5rem;
      border: 1px solid var(--bg-grid);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-body);
      max-width: 600px;
      transition: transform 0.2s;
    }

    .og-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .og-image {
      width: 100%;
      aspect-ratio: 1.91 / 1;
      object-fit: cover;
      background: var(--bg-movie);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    .og-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .og-content {
      padding: 1rem;
    }

    .og-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }

    .og-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }

    .og-url {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .meta-details {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-body);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .meta-tag {
      margin: 0.25rem 0;
      color: var(--text-secondary);
    }

    .meta-tag strong {
      color: #4a9eff;
    }

    .meta-tag .value {
      color: #6ee7b7;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .has-image {
      background: #064e3b;
      color: #6ee7b7;
    }

    .no-image {
      background: #422006;
      color: #fbbf24;
    }
  </style>

  <div class="seo-preview">
    <div class="header">
      <h1>SEO & OpenGraph Preview</h1>
      <p>Visual preview of how each route appears when shared on social media</p>
    </div>

    <div class="routes-grid">
      {routes.map(route => {
        const fullUrl = `${siteUrl}${route.url}`;
        const encodedUrl = encodeURIComponent(fullUrl);

        return (
          <div class="route-card">
            <div class="route-header">
              <div class="route-name">
                {route.name}
                <span class={`status-badge ${route.hasImage ? 'has-image' : 'no-image'}`}>
                  {route.hasImage ? 'With Image' : 'Text Only'}
                </span>
              </div>
              <div class="route-url">{route.url}</div>
            </div>

            <div class="og-card">
              <div class="og-image">
                {route.image ? (
                  <img src={route.image} alt={route.title} />
                ) : (
                  <span>No OpenGraph Image</span>
                )}
              </div>
              <div class="og-content">
                <div class="og-title">{route.title}</div>
                <div class="og-description">{route.description}</div>
                <div class="og-url">{siteName}</div>
              </div>
            </div>

            <div class="meta-details">
              <div class="meta-tag">
                <strong>og:title:</strong> <span class="value">"{route.title}"</span>
              </div>
              <div class="meta-tag">
                <strong>og:description:</strong> <span class="value">"{route.description}"</span>
              </div>
              <div class="meta-tag">
                <strong>og:url:</strong> <span class="value">"{fullUrl}"</span>
              </div>
              {route.image ? (
                <div class="meta-tag">
                  <strong>og:image:</strong> <span class="value">"{siteUrl}{route.image}"</span>
                </div>
              ) : (
                <div class="meta-tag">
                  <strong>og:image:</strong> <span style="color: #666;">(not set)</span>
                </div>
              )}
              <div class="meta-tag">
                <strong>og:type:</strong> <span class="value">"website"</span>
              </div>
              <div class="meta-tag">
                <strong>og:site_name:</strong> <span class="value">"{siteName}"</span>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </div>
</Layout>
