---
/**
 * Compact toolbar for session list page.
 * Row 1: View toggle (always visible, all view modes)
 * Row 2: Search + filter disclosure button (hidden in single view)
 * Disclosure panel: Sort, director, actor, decade filters
 */
import Icon from '../Icon.astro';

interface Props {
  viewMode?: 'list' | 'card' | 'single';
  sortBy?: string;
  directors?: string[];
  actors?: string[];
  decades?: string[];
}

const {
  viewMode = 'card',
  sortBy = 'alpha',
  directors = [],
  actors = [],
  decades = [],
} = Astro.props;
---

<div class="list-toolbar">
  <!-- Row 1: View mode (always visible) -->
  <div class="toolbar-view-row">
    <span class="toolbar-label">View</span>
    <div class="view-toggle" role="radiogroup" aria-label="View mode">
      <button
        class:list={['view-btn', { active: viewMode === 'list' }]}
        data-view="list"
        role="radio"
        aria-checked={viewMode === 'list'}
        aria-label="List view"
      >
        <Icon name="rows-4" size={16} />
      </button>
      <button
        class:list={['view-btn', { active: viewMode === 'card' }]}
        data-view="card"
        role="radio"
        aria-checked={viewMode === 'card'}
        aria-label="Card view"
      >
        <Icon name="grid-2x2" size={16} />
      </button>
      <button
        class:list={['view-btn', { active: viewMode === 'single' }]}
        data-view="single"
        role="radio"
        aria-checked={viewMode === 'single'}
        aria-label="Single card view"
      >
        <Icon name="square" size={16} />
      </button>
    </div>
  </div>

  <!-- Row 2+: Search, filter toggle, disclosure (hidden in single view) -->
  <div class="toolbar-search-section" id="toolbar-search-section">
    <div class="toolbar-search-row">
      <div class="search-input-wrapper">
        <svg class="search-icon" width="14" height="14" viewBox="0 0 16 16" fill="none">
          <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.5"/>
          <path d="M11 11l3.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search films..."
          data-placeholder-sm="Search films..."
          data-placeholder-lg="Search titles, directors, actors..."
          aria-label="Search films by title, director, or actor"
          autocomplete="off"
        />
        <button id="search-clear" class="search-clear" aria-label="Clear search" style="display:none">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
            <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <button
        class="filter-toggle-btn"
        id="filter-toggle-btn"
        aria-label="Toggle filters and sort"
        aria-expanded="false"
        aria-controls="filter-disclosure"
      >
        <Icon name="list-filter" size={16} />
        <span class="filter-badge" id="filter-badge">0</span>
      </button>
    </div>

    <!-- Filter disclosure panel -->
    <div class="filter-disclosure" id="filter-disclosure">
      <div class="filter-disclosure-inner">
        <div class="filter-row">
          <span class="filter-row-label">Sort</span>
          <select class="toolbar-select" id="sort-select" aria-label="Sort movies by">
            <option value="alpha" selected={sortBy === 'alpha'}>A &rarr; Z</option>
            <option value="year" selected={sortBy === 'year'}>Year</option>
            <option value="director" selected={sortBy === 'director'}>Director</option>
            <option value="marked" selected={sortBy === 'marked'}>Marked</option>
          </select>
        </div>

        <div class="filter-row">
          <span class="filter-row-label">
            <Icon name="megaphone" size={14} />
            <span>Director</span>
          </span>
          <select class="toolbar-select filter-select" id="filter-director" aria-label="Filter by director">
            <option value="">All directors</option>
            {directors.map(d => (
              <option value={d.toLowerCase()}>{d}</option>
            ))}
          </select>
        </div>

        <div class="filter-row">
          <span class="filter-row-label">
            <Icon name="users-round" size={14} />
            <span>Actor</span>
          </span>
          <select class="toolbar-select filter-select" id="filter-actor" aria-label="Filter by actor">
            <option value="">All actors</option>
            {actors.map(a => (
              <option value={a.toLowerCase()}>{a}</option>
            ))}
          </select>
        </div>

        <div class="filter-row filter-row-wrap">
          <span class="filter-row-label">
            <Icon name="calendar" size={14} />
            <span>Decade</span>
          </span>
          <div class="decade-toggles" id="decade-toggles" role="group" aria-label="Filter by decade (multi-select)">
            {decades.map(d => (
              <button
                class="decade-btn"
                data-decade={d}
                aria-pressed="false"
              >
                {d}
              </button>
            ))}
          </div>
        </div>

        <div class="filter-row filter-actions" id="filter-results" style="display:none">
          <span class="filter-results-text" id="filter-results-text"></span>
          <button class="filter-clear-btn" id="filter-clear-all" aria-label="Clear all filters">Clear all</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Responsive search placeholder ---
  const searchEl = document.getElementById('search-input') as HTMLInputElement;
  function updateSearchPlaceholder() {
    if (!searchEl) return;
    const wide = window.matchMedia('(min-width: 640px)').matches;
    searchEl.placeholder = wide
      ? searchEl.dataset.placeholderLg!
      : searchEl.dataset.placeholderSm!;
  }
  updateSearchPlaceholder();
  window.matchMedia('(min-width: 640px)').addEventListener('change', updateSearchPlaceholder);

  // --- Filter disclosure toggle ---
  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  const filterDisclosure = document.getElementById('filter-disclosure');

  filterToggleBtn?.addEventListener('click', () => {
    const isOpen = filterDisclosure?.classList.contains('open');
    filterDisclosure?.classList.toggle('open', !isOpen);
    filterToggleBtn.classList.toggle('active', !isOpen);
    filterToggleBtn.setAttribute('aria-expanded', String(!isOpen));
  });

  // --- Hide search/filter section in single view ---
  const searchSection = document.getElementById('toolbar-search-section');

  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = (btn as HTMLElement).dataset.view;
      if (searchSection) {
        searchSection.style.display = view === 'single' ? 'none' : '';
      }
      // Close disclosure when switching to single view
      if (view === 'single' && filterDisclosure?.classList.contains('open')) {
        filterDisclosure.classList.remove('open');
        filterToggleBtn?.classList.remove('active');
        filterToggleBtn?.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // --- Decade toggle buttons ---
  const decadeToggles = document.getElementById('decade-toggles');

  decadeToggles?.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.decade-btn') as HTMLElement;
    if (!btn) return;
    const isActive = btn.getAttribute('aria-pressed') === 'true';
    btn.setAttribute('aria-pressed', String(!isActive));
    btn.classList.toggle('active', !isActive);
    // Dispatch a custom event so the page script can react
    decadeToggles.dispatchEvent(new Event('change', { bubbles: true }));
  });

  // --- Filter badge count ---
  function getActiveDecadeCount(): number {
    return decadeToggles?.querySelectorAll('.decade-btn[aria-pressed="true"]').length ?? 0;
  }

  function updateFilterBadge() {
    const badge = document.getElementById('filter-badge');
    if (!badge) return;

    const director = (document.getElementById('filter-director') as HTMLSelectElement)?.value;
    const actor = (document.getElementById('filter-actor') as HTMLSelectElement)?.value;
    const hasDecades = getActiveDecadeCount() > 0;
    const count = (director ? 1 : 0) + (actor ? 1 : 0) + (hasDecades ? 1 : 0);

    badge.textContent = String(count);
    badge.classList.toggle('visible', count > 0);
    filterToggleBtn?.classList.toggle('has-filters', count > 0);
  }

  document.getElementById('filter-director')?.addEventListener('change', updateFilterBadge);
  document.getElementById('filter-actor')?.addEventListener('change', updateFilterBadge);
  decadeToggles?.addEventListener('change', updateFilterBadge);
  document.getElementById('filter-clear-all')?.addEventListener('click', () => {
    // Clear decade toggles
    decadeToggles?.querySelectorAll('.decade-btn').forEach(btn => {
      btn.setAttribute('aria-pressed', 'false');
      btn.classList.remove('active');
    });
    requestAnimationFrame(updateFilterBadge);
  });

  updateFilterBadge();
</script>

<style>
  /* --- Toolbar container --- */
  .list-toolbar {
    position: sticky;
    top: 0;
    z-index: var(--z-drawer-bg);
    background: color-mix(in srgb, var(--bg-body) 85%, transparent);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--bg-movie-hover);
    margin: 0 -12px 12px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* --- View row (always visible) --- */
  .toolbar-view-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toolbar-label {
    font-size: 12px;
    font-weight: 400;
    text-transform: uppercase;
    color: var(--text-tertiary);
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.01em;
  }

  .view-toggle {
    display: inline-flex;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 6px;
    overflow: hidden;
  }

  .view-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 32px;
    padding: 0;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .view-btn:not(:last-child) {
    border-right: 1px solid var(--bg-movie-hover);
  }

  .view-btn:hover {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  .view-btn.active {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  /* --- Search section (hidden in single view via JS) --- */
  .toolbar-search-section {
    display: flex;
    flex-direction: column;
  }

  /* --- Search row --- */
  .toolbar-search-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-input-wrapper {
    position: relative;
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    color: var(--text-tertiary);
    pointer-events: none;
    transition: color 0.15s;
  }

  .search-input {
    width: 100%;
    padding: 8px 32px 8px 32px;
    font-size: 14px;
    font-family: inherit;
    color: var(--text-primary);
    background: var(--bg-movie);
    border: 1px solid var(--bg-movie-hover);
    border-radius: 8px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-input::placeholder {
    color: var(--text-tertiary);
  }

  .search-input:focus {
    border-color: var(--accent);
  }

  .search-clear {
    position: absolute;
    right: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    padding: 0;
    background: transparent;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    border-radius: 4px;
    transition: color 0.15s;
  }

  .search-clear:hover {
    color: var(--text-primary);
  }

  /* --- Filter toggle button --- */
  .filter-toggle-btn {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    background: transparent;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    flex-shrink: 0;
    transition: background-color 0.15s, color 0.15s, border-color 0.15s;
  }

  .filter-toggle-btn:hover,
  .filter-toggle-btn.active {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  .filter-toggle-btn.has-filters {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* --- Filter badge --- */
  .filter-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 16px;
    height: 16px;
    padding: 0 4px;
    background: var(--accent);
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    border-radius: 8px;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .filter-badge.visible {
    display: flex;
  }

  /* --- Filter disclosure panel --- */
  .filter-disclosure {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  .filter-disclosure.open {
    grid-template-rows: 1fr;
  }

  .filter-disclosure-inner {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding-top: 10px;
  }

  /* --- Filter rows --- */
  .filter-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 5px 4px;
  }

  .filter-row-wrap {
    flex-wrap: wrap;
  }

  .filter-row-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 400;
    text-transform: uppercase;
    color: var(--text-tertiary);
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.01em;
    min-width: 90px;
    flex-shrink: 0;
  }

  /* --- Decade toggle buttons --- */
  .decade-toggles {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    flex: 1;
    min-width: 0;
  }

  .decade-btn {
    padding: 4px 10px;
    font-size: 12px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-movie);
    border: 1px solid var(--bg-movie-hover);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .decade-btn:hover {
    background: var(--bg-movie-hover);
    color: var(--text-primary);
  }

  .decade-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  /* --- Selects (shared for sort + filters) --- */
  .toolbar-select {
    appearance: none;
    -webkit-appearance: none;
    flex: 1;
    min-width: 0;
    padding: 6px 28px 6px 10px;
    font-size: 13px;
    font-family: inherit;
    color: var(--text-primary);
    background: var(--bg-movie);
    border: 1px solid var(--bg-movie-hover);
    border-radius: 6px;
    cursor: pointer;
    text-overflow: ellipsis;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%2364748b' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }

  .toolbar-select:focus {
    outline: 2px solid var(--accent);
    outline-offset: 1px;
  }

  /* Active filter highlight */
  .filter-select.active-filter {
    border-color: var(--accent);
    background-color: color-mix(in srgb, var(--accent) 8%, var(--bg-movie));
  }

  /* --- Filter actions row --- */
  .filter-actions {
    justify-content: flex-end;
    padding-top: 6px;
    border-top: 1px solid var(--bg-movie-hover);
    margin-top: 4px;
  }

  .filter-results-text {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .filter-clear-btn {
    padding: 4px 10px;
    font-size: 11px;
    font-family: inherit;
    font-weight: 500;
    color: var(--accent);
    background: transparent;
    border: 1px solid var(--accent);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    margin-left: auto;
  }

  .filter-clear-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  @media (prefers-reduced-motion: reduce) {
    .filter-disclosure,
    .view-btn,
    .filter-toggle-btn {
      transition: none;
    }
  }
</style>
