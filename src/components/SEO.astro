---
interface Props {
  title: string;
  description: string;
  canonical: string;
  ogType?: 'website' | 'article';
  ogImage?: string;
  ogImageAlt?: string;
  noindex?: boolean;
  structuredData?: object | object[];
  twitterCard?: 'summary' | 'summary_large_image';
}

const {
  title,
  description,
  canonical,
  ogType = 'website',
  ogImage = '/og-default.jpg',
  ogImageAlt = 'FilmForum',
  noindex = false,
  structuredData,
  twitterCard = 'summary_large_image',
} = Astro.props;

// Fallback URL for SEO tags when Astro.site is not configured
// This is used during development or if the `site` option is missing in astro.config.mjs
// The fallback value should match the production site URL configured in astro.config.mjs
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://filmforum.org';
const fullCanonical = canonical.startsWith('http') ? canonical : `${siteUrl}${canonical}`;
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`;
const siteName = 'FilmForum';

/**
 * Smart description truncation that:
 * 1. Truncates at word boundaries (not mid-word)
 * 2. Targets 150-160 chars (optimal for SEO)
 * 3. Adds "..." only if truncated
 * 4. Never exceeds 160 chars
 */
function truncateDescription(text: string, maxLength: number = 160): string {
  if (text.length <= maxLength) {
    return text;
  }

  // Leave room for "..." (3 chars)
  const targetLength = maxLength - 3;

  // Find the last space before the target length
  const truncated = text.substring(0, targetLength);
  const lastSpace = truncated.lastIndexOf(' ');

  // If we found a space, truncate there; otherwise use the full target length
  const finalText = lastSpace > 0 ? truncated.substring(0, lastSpace) : truncated;

  return finalText + '...';
}

const truncatedDescription = truncateDescription(description);
---

<!-- Basic SEO -->
<title>{title}</title>
<meta name="description" content={truncatedDescription} />
<link rel="canonical" href={fullCanonical} />
{noindex && <meta name="robots" content="noindex, follow" />}

<!-- OpenGraph -->
<meta property="og:type" content={ogType} />
<meta property="og:title" content={title} />
<meta property="og:description" content={truncatedDescription} />
<meta property="og:url" content={fullCanonical} />
<meta property="og:image" content={fullOgImage} />
<meta property="og:image:alt" content={ogImageAlt} />
<meta property="og:site_name" content={siteName} />

<!-- Twitter Card -->
<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={truncatedDescription} />
<meta name="twitter:image" content={fullOgImage} />
<meta name="twitter:image:alt" content={ogImageAlt} />

<!-- JSON-LD Structured Data -->
{structuredData && (
  Array.isArray(structuredData)
    ? structuredData.map((data) => (
        <script type="application/ld+json" set:html={JSON.stringify(data)} />
      ))
    : <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
)}
