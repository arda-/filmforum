---
/**
 * Inline view toolbar for the calendar page.
 * Contains set-once display settings: Timeline/Grid, Fit to width, Mon/Sun, gear popover.
 * Not sticky — sits above the calendar in normal flow.
 */
import Switch from '@components/Switch.astro';
import Icon from '@components/Icon.astro';
import Tooltip from '@components/Tooltip.astro';
---

<div class="calendar-view-toolbar">
  <div class="toolbar-row">
    <div class="toolbar-left">
      <!-- Timeline / Grid toggle -->
      <div class="toolbar-group toolbar-group-view">
        <span class="toolbar-label">View</span>
        <div class="segmented-toggle" role="radiogroup" aria-label="Calendar view mode">
          <button
            class="seg-btn active"
            data-view="timeline"
            role="radio"
            aria-checked="true"
            aria-label="Timeline view"
            id="view-mode-timeline"
          >
            <Icon name="gallery-vertical" size={14} />
            <span class="seg-btn-label">Timeline</span>
          </button>
          <button
            class="seg-btn"
            data-view="grid"
            role="radio"
            aria-checked="false"
            aria-label="Rows view"
            id="view-mode-grid"
          >
            <Icon name="rows-2" size={14} />
            <span class="seg-btn-label">Rows</span>
          </button>
        </div>
      </div>

      <!-- Width toggle: Fit / Content -->
      <div class="toolbar-group toolbar-group-width">
        <span class="toolbar-label">Width</span>
        <Tooltip text="At this viewport width, calendar content naturally fits">
          <div class="segmented-toggle" role="radiogroup" aria-label="Content width mode">
            <button
              class="seg-btn active"
              data-width="fit"
              role="radio"
              aria-checked="true"
              aria-label="Fit to window width"
              id="width-fit"
            >
              <Icon name="minimize-2" size={14} />
              <span class="seg-btn-label">Fit</span>
            </button>
            <button
              class="seg-btn"
              data-width="content"
              role="radio"
              aria-checked="false"
              aria-label="Show full content width"
              id="width-content"
            >
              <Icon name="maximize" size={14} />
              <span class="seg-btn-label">Content</span>
            </button>
          </div>
        </Tooltip>
      </div>

      <!-- Hidden fit-width switch for backward compat with existing JS -->
      <div style="display:none">
        <Switch id="fit-width-switch" label="" checked />
      </div>
    </div>

    <!-- Gear button → popover -->
    <div class="toolbar-group toolbar-group--end">
      <button
        class="gear-btn"
        id="view-settings-btn"
        aria-label="View settings"
        aria-expanded="false"
        aria-controls="view-settings-popover"
      >
        <Icon name="settings" size={16} />
      </button>

      <div class="view-settings-popover" id="view-settings-popover">
        <div class="popover-section">
          <div class="popover-row">
            <span class="popover-label">Start week on</span>
            <div class="segmented-toggle segmented-toggle-compact" role="radiogroup" aria-label="Week start day">
              <button
                class="seg-btn"
                data-weekstart="sun"
                role="radio"
                aria-checked="false"
                aria-label="Start week on Sunday"
                id="weekstart-sun"
              >Sun</button>
              <button
                class="seg-btn active"
                data-weekstart="mon"
                role="radio"
                aria-checked="true"
                aria-label="Start week on Monday"
                id="weekstart-mon"
              >Mon</button>
            </div>
          </div>
        </div>
        <div class="popover-section">
          <Switch id="highlight-unique-toggle" label="Highlight unique showings (★)" checked small />
        </div>
        <div class="popover-section desktop-only">
          <Switch id="highlight-alternate-toggle" label="Highlight alternate on hover" checked small />
        </div>
      </div>
    </div>
  </div>

  <!-- Tile display options row -->
  <div class="toolbar-row">
    <span class="toolbar-label">Details</span>
    <div class="segmented-toggle">
      <button
        class="seg-btn"
        data-detail="year-director"
        aria-pressed="false"
        aria-label="Show year and director"
      >
        <input type="checkbox" id="show-year-director-checkbox" style="display: none;" />
        <Icon name="megaphone" size={14} />
        <span class="seg-btn-text-short seg-btn-label">Year & Dir.</span>
        <span class="seg-btn-text-full seg-btn-label">Year & Director</span>
      </button>
      <button
        class="seg-btn"
        data-detail="runtime"
        aria-pressed="false"
        aria-label="Show runtime"
      >
        <input type="checkbox" id="show-runtime-checkbox" style="display: none;" />
        <Icon name="timer" size={14} />
        <span class="seg-btn-label">Runtime</span>
      </button>
      <button
        class="seg-btn"
        data-detail="cast"
        aria-pressed="false"
        aria-label="Show cast"
      >
        <input type="checkbox" id="show-actors-checkbox" style="display: none;" />
        <Icon name="users-round" size={14} />
        <span class="seg-btn-label">Cast</span>
      </button>
      <button
        class="seg-btn"
        data-detail="image"
        aria-pressed="false"
        aria-label="Show poster image"
      >
        <input type="checkbox" id="show-image-checkbox" style="display: none;" />
        <Icon name="image" size={14} />
        <span class="seg-btn-label">Image</span>
      </button>
    </div>
  </div>

</div>

<!-- Hidden switch elements that the existing JS references by ID -->
<div style="display:none">
  <Switch id="timeline-mode-toggle" label="" checked />
  <Switch id="week-start-toggle" label="" checked />
</div>

<script>
  // Module-level variable to store saved detail view states
  let savedDetailStates: { [key: string]: boolean } = {};

  // Detail toggle buttons - needed by syncWidth()
  const detailButtons = document.querySelectorAll('.toolbar-row .seg-btn[data-detail]');

  // --- Segmented toggle: Timeline / Grid ---
  const viewTimelineBtn = document.getElementById('view-mode-timeline');
  const viewGridBtn = document.getElementById('view-mode-grid');
  const timelineSwitch = document.querySelector('#timeline-mode-toggle input') as HTMLInputElement;

  function syncViewMode(isTimeline: boolean) {
    viewTimelineBtn?.classList.toggle('active', isTimeline);
    viewGridBtn?.classList.toggle('active', !isTimeline);
    viewTimelineBtn?.setAttribute('aria-checked', String(isTimeline));
    viewGridBtn?.setAttribute('aria-checked', String(!isTimeline));
    if (timelineSwitch) {
      timelineSwitch.checked = isTimeline;
      timelineSwitch.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  viewTimelineBtn?.addEventListener('click', () => syncViewMode(true));
  viewGridBtn?.addEventListener('click', () => syncViewMode(false));

  // Sync initial state from hidden switch (which restoreFromUrl may have set)
  function initViewMode() {
    if (timelineSwitch) {
      const isTimeline = timelineSwitch.checked;
      viewTimelineBtn?.classList.toggle('active', isTimeline);
      viewGridBtn?.classList.toggle('active', !isTimeline);
      viewTimelineBtn?.setAttribute('aria-checked', String(isTimeline));
      viewGridBtn?.setAttribute('aria-checked', String(!isTimeline));
    }
  }

  // --- Width toggle: Fit / Content ---
  const widthFitBtn = document.getElementById('width-fit');
  const widthContentBtn = document.getElementById('width-content');
  const fitWidthSwitch = document.querySelector('#fit-width-switch input') as HTMLInputElement;

  function syncWidth(isFit: boolean) {
    widthFitBtn?.classList.toggle('active', isFit);
    widthContentBtn?.classList.toggle('active', !isFit);
    widthFitBtn?.setAttribute('aria-checked', String(isFit));
    widthContentBtn?.setAttribute('aria-checked', String(!isFit));
    if (fitWidthSwitch) {
      fitWidthSwitch.checked = isFit;
      fitWidthSwitch.dispatchEvent(new Event('change', { bubbles: true }));
    }

    const detailCheckboxes = {
      'show-year-director-checkbox': document.getElementById('show-year-director-checkbox') as HTMLInputElement,
      'show-runtime-checkbox': document.getElementById('show-runtime-checkbox') as HTMLInputElement,
      'show-actors-checkbox': document.getElementById('show-actors-checkbox') as HTMLInputElement,
      'show-image-checkbox': document.getElementById('show-image-checkbox') as HTMLInputElement
    };

    // When switching to Fit mode, save and disable all detail views
    if (isFit) {
      // Save current states before disabling
      savedDetailStates = {};
      Object.entries(detailCheckboxes).forEach(([id, checkbox]) => {
        if (checkbox) {
          savedDetailStates[id] = checkbox.checked;
          if (checkbox.checked) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
      });

      // Update button active states
      detailButtons.forEach(button => {
        button.classList.remove('active');
        button.setAttribute('aria-pressed', 'false');
      });

      // Remove body classes
      document.body.classList.remove('show-year-director', 'show-runtime', 'show-actors', 'show-image', 'scrim-enabled', 'blur-enabled');
    } else {
      // When switching to Content mode, restore saved states
      if (Object.keys(savedDetailStates).length > 0) {
        Object.entries(detailCheckboxes).forEach(([id, checkbox]) => {
          if (checkbox && savedDetailStates[id]) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });

        // Update button active states
        detailButtons.forEach(button => {
          const checkbox = button.querySelector('input[type="checkbox"]') as HTMLInputElement;
          if (checkbox && checkbox.checked) {
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
          }
        });
      }
    }
  }

  widthFitBtn?.addEventListener('click', () => syncWidth(true));
  widthContentBtn?.addEventListener('click', () => syncWidth(false));

  function initWidth() {
    if (fitWidthSwitch) {
      const isFit = fitWidthSwitch.checked;
      widthFitBtn?.classList.toggle('active', isFit);
      widthContentBtn?.classList.toggle('active', !isFit);
      widthFitBtn?.setAttribute('aria-checked', String(isFit));
      widthContentBtn?.setAttribute('aria-checked', String(!isFit));
    }
  }

  // --- Width toggle tooltip (only show at 640px+) ---
  const widthTooltip = document.querySelector('.toolbar-group-width .tooltip-wrapper');
  const mediaQuery640 = window.matchMedia('(min-width: 640px)');

  function updateWidthTooltip(e: MediaQueryListEvent | MediaQueryList) {
    if (widthTooltip) {
      // At 640px+, enable tooltip (both options behave similarly)
      // Below 640px, disable tooltip (toggle is meaningful)
      widthTooltip.setAttribute('data-disabled', e.matches ? 'false' : 'true');
    }
  }

  updateWidthTooltip(mediaQuery640);
  mediaQuery640.addEventListener('change', updateWidthTooltip);

  // --- Week start segmented toggle ---
  const weekstartMonBtn = document.getElementById('weekstart-mon');
  const weekstartSunBtn = document.getElementById('weekstart-sun');
  const weekStartSwitch = document.querySelector('#week-start-toggle input') as HTMLInputElement;

  function syncWeekStart(isMondayStart: boolean) {
    weekstartMonBtn?.classList.toggle('active', isMondayStart);
    weekstartSunBtn?.classList.toggle('active', !isMondayStart);
    weekstartMonBtn?.setAttribute('aria-checked', String(isMondayStart));
    weekstartSunBtn?.setAttribute('aria-checked', String(!isMondayStart));
    if (weekStartSwitch) {
      weekStartSwitch.checked = isMondayStart;
      weekStartSwitch.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  weekstartMonBtn?.addEventListener('click', () => syncWeekStart(true));
  weekstartSunBtn?.addEventListener('click', () => syncWeekStart(false));

  function initWeekStart() {
    if (weekStartSwitch) {
      const isMon = weekStartSwitch.checked;
      weekstartMonBtn?.classList.toggle('active', isMon);
      weekstartSunBtn?.classList.toggle('active', !isMon);
      weekstartMonBtn?.setAttribute('aria-checked', String(isMon));
      weekstartSunBtn?.setAttribute('aria-checked', String(!isMon));
    }
  }

  // --- Detail toggle buttons ---
  detailButtons.forEach(button => {
    button.addEventListener('click', () => {
      const checkbox = button.querySelector('input[type="checkbox"]') as HTMLInputElement;
      if (checkbox) {
        // Toggle the checkbox state
        checkbox.checked = !checkbox.checked;

        // Update button visual state
        button.classList.toggle('active', checkbox.checked);
        button.setAttribute('aria-pressed', String(checkbox.checked));

        // Dispatch change event so existing calendar logic picks it up
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  });

  function initDetailButtons() {
    detailButtons.forEach(button => {
      const checkbox = button.querySelector('input[type="checkbox"]') as HTMLInputElement;
      if (checkbox) {
        // Sync button state from checkbox (which may have been set by URL restore)
        button.classList.toggle('active', checkbox.checked);
        button.setAttribute('aria-pressed', String(checkbox.checked));
      }
    });
  }

  // --- Gear popover ---
  const gearBtn = document.getElementById('view-settings-btn');
  const popover = document.getElementById('view-settings-popover');

  gearBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = popover?.classList.contains('open');
    popover?.classList.toggle('open', !isOpen);
    gearBtn.setAttribute('aria-expanded', String(!isOpen));
  });

  // Close popover on outside click
  document.addEventListener('click', (e) => {
    if (!popover?.contains(e.target as Node) && e.target !== gearBtn) {
      popover?.classList.remove('open');
      gearBtn?.setAttribute('aria-expanded', 'false');
    }
  });

  // Close popover on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && popover?.classList.contains('open')) {
      popover.classList.remove('open');
      gearBtn?.setAttribute('aria-expanded', 'false');
      gearBtn?.focus();
    }
  });

  // --- Init after URL restore ---
  // Use a microtask to run after the main script's restoreFromUrl()
  queueMicrotask(() => {
    initViewMode();
    initWidth();
    initWeekStart();
    initDetailButtons();
  });
</script>

<style>
  .calendar-view-toolbar {
    margin-bottom: 12px;
    padding: 0 4px;
  }

  .toolbar-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    flex: 1;
    min-width: 0;
  }

  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .display-options-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .toolbar-group--end {
    /* Gear button stays on the right, doesn't wrap */
    margin-left: auto;
    flex-shrink: 0;
    position: relative;
  }

  /* Hide width toggle at 640px+ where it's not needed */
  @media (min-width: 640px) {
    .toolbar-group-width {
      display: none;
    }
  }

  /* Segmented toggle (Timeline/Grid, Mon/Sun) */
  .segmented-toggle {
    display: inline-flex;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 6px;
    overflow: hidden;
    background: var(--bg-body);
  }

  .seg-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 400;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: background-color 0.15s ease, color 0.15s ease;
  }

  .seg-btn:not(:last-child) {
    border-right: 1px solid var(--bg-movie-hover);
  }

  .seg-btn:hover {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  .seg-btn.active {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  .seg-btn svg {
    flex-shrink: 0;
  }

  .seg-btn-label {
    display: none;
  }

  @media (min-width: 640px) {
    .seg-btn-label {
      display: inline;
    }
  }

  /* Responsive text for Year/Director button */
  .seg-btn-text-short {
    display: inline;
  }

  .seg-btn-text-full {
    display: none;
  }

  @media (min-width: 640px) {
    .seg-btn-text-short {
      display: none;
    }

    .seg-btn-text-full {
      display: inline;
    }
  }

  .toolbar-label {
    font-size: 12px;
    font-weight: 400;
    text-transform: uppercase;
    color: var(--text-tertiary);
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.01em;
  }


  /* Compact toggle button (Fit width) */
  .compact-toggle {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 400;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
  }

  .compact-toggle:hover {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  .compact-toggle.active {
    background: var(--bg-movie);
    color: var(--text-primary);
    border-color: var(--accent);
  }

  .compact-toggle svg {
    flex-shrink: 0;
  }

  /* Gear button */
  .gear-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    background: transparent;
    border: 1px solid var(--bg-movie-hover);
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: background-color 0.15s ease, color 0.15s ease;
  }

  .gear-btn:hover,
  .gear-btn[aria-expanded="true"] {
    background: var(--bg-movie);
    color: var(--text-primary);
  }

  /* Popover */
  .view-settings-popover {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    min-width: 220px;
    padding: 12px;
    background: var(--bg-body);
    border: 1px solid var(--bg-movie-hover);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    z-index: calc(var(--z-drawer-bg) + 1);
  }

  .view-settings-popover.open {
    display: block;
  }

  .popover-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .popover-section + .popover-section {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--bg-movie-hover);
  }

  .popover-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .popover-label {
    font-size: 12px;
    font-weight: 400;
    color: var(--text-secondary);
    font-family: 'Barlow Semi Condensed', sans-serif;
    text-transform: uppercase;
    letter-spacing: -0.01em;
  }

  .segmented-toggle-compact {
    min-width: auto;
  }


  /* Mobile: stack toolbar more compactly */
  @media (max-width: 479px) {
    .toolbar-row {
      gap: 8px;
    }
  }

  /* Hidden helper switches are truly hidden */
  [style*="display:none"] {
    position: absolute;
    width: 0;
    height: 0;
    overflow: hidden;
  }
</style>
