---
import Layout from '../layouts/Layout.astro';
import CalendarGrid from '../components/CalendarGrid.astro';
import DayCell from '../components/DayCell.astro';
import { Switch } from 'webcoreui/astro';

// Generate Feb 2026 dates
const dates: string[] = [];
for (let i = 1; i <= 28; i++) {
  dates.push(`2026-02-${i.toString().padStart(2, '0')}`);
}
---

<Layout title="Tenement Stories - Film Forum Feb 2026">
  <h1>Tenement Stories: Timeline View</h1>
  <p class="subtitle">Film Forum, NYC, February 2026</p>

  <div class="controls">
    <Switch id="week-start-toggle" label="Start week on Monday" checked small />
    <Switch id="duration-mode-toggle" label="Duration mode" checked small />
  </div>

  <CalendarGrid>
    {dates.map(date => (
      <DayCell date={date} />
    ))}
  </CalendarGrid>

  <p class="legend">Click any movie to buy tickets. Times are PM unless marked "FF Jr."</p>
</Layout>

<script>
  const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const PX_PER_MIN = 0.7;

  interface Movie {
    Movie: string;
    Time: string;
    Tickets: string;
    Datetime: string;
    year?: string;
    director?: string;
    runtime?: string;
    actors?: string;
    _col?: number;
    _hasOverlap?: boolean;
  }

  let moviesByDate: Record<string, Movie[]> = {};
  let globalRange = { start: Infinity, end: 0, range: 0 };
  let uniformHeight = 0;

  function toTitleCase(str: string) {
    return str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
  }

  function parseTimeToMins(timeStr: string) {
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (!match) return 0;
    let h = parseInt(match[1]);
    const m = parseInt(match[2]);
    const isMorning = timeStr.includes('FF Jr') || h === 11;
    if (!isMorning && h < 12) h += 12;
    return h * 60 + m;
  }

  function getDayTimeRange(movies: Movie[]) {
    let minStart = Infinity, maxEnd = 0;
    movies.forEach(m => {
      const start = parseTimeToMins(m.Time);
      const runtime = parseInt(m.runtime || '90');
      const end = start + runtime;
      if (start < minStart) minStart = start;
      if (end > maxEnd) maxEnd = end;
    });
    return { start: minStart, end: maxEnd, range: maxEnd - minStart };
  }

  function assignOverlapColumns(movies: Movie[]) {
    const sorted = [...movies].sort((a, b) => parseTimeToMins(a.Time) - parseTimeToMins(b.Time));
    sorted.forEach((movie, i) => {
      movie._col = 0;
      movie._hasOverlap = false;
      const myStart = parseTimeToMins(movie.Time);
      for (let j = 0; j < i; j++) {
        const prev = sorted[j];
        const prevEnd = parseTimeToMins(prev.Time) + parseInt(prev.runtime || '90');
        if (prevEnd > myStart) {
          movie._col = 1;
          prev._hasOverlap = true;
          movie._hasOverlap = true;
          break;
        }
      }
    });
    return sorted;
  }

  function createMovieElement(movie: Movie, isTimeline: boolean, topPx?: number, heightPx?: number) {
    const el = document.createElement('div');
    const classes = ['movie'];
    if (isTimeline) {
      classes.push('movie--timeline');
      if (movie._col === 1) classes.push('overlap-col-1');
      else if (movie._hasOverlap) classes.push('overlap-col-0', 'has-overlap');
    }
    el.className = classes.join(' ');

    if (isTimeline && topPx !== undefined && heightPx !== undefined) {
      el.style.top = `${topPx + 28}px`;
      el.style.height = `${heightPx}px`;
    }

    const runtime = movie.runtime ? movie.runtime.replace(' minutes', 'min').replace(' ', '') : '';
    const metaText = [movie.year, movie.director, runtime].filter(Boolean).join(', ');
    const actors = movie.actors ? movie.actors.split(',').slice(0, 3).map(a => a.trim()).join(', ') : '';

    el.innerHTML = `
      <a href="${movie.Tickets}">
        <span class="movie-time">${movie.Time}</span>
        <span class="movie-title">${toTitleCase(movie.Movie)}</span>
        <div class="movie-meta">
          <span class="movie-info">${metaText}</span>
          ${actors ? `<span class="movie-actors">${actors}</span>` : ''}
        </div>
      </a>
    `;
    return el;
  }

  function renderAllDays() {
    const durationMode = (document.getElementById('duration-mode-toggle') as HTMLInputElement).checked;

    Object.entries(moviesByDate).forEach(([date, dayMovies]) => {
      const dayCell = document.querySelector(`[data-date="${date}"]`) as HTMLElement;
      if (!dayCell) return;

      // Clear and reset
      const dayNumber = dayCell.dataset.dayNumber;
      dayCell.innerHTML = '';
      dayCell.classList.remove('timeline-view');
      dayCell.classList.add('has-movies');
      dayCell.style.height = '';

      // Re-add day number
      const dayNumDiv = document.createElement('div');
      dayNumDiv.className = 'day-number';
      dayNumDiv.textContent = dayNumber || '';
      dayCell.appendChild(dayNumDiv);

      if (durationMode) {
        dayCell.style.height = `${uniformHeight}px`;
        dayCell.classList.add('timeline-view');
        const sorted = assignOverlapColumns(dayMovies);
        sorted.forEach(movie => {
          const start = parseTimeToMins(movie.Time);
          const runtime = parseInt(movie.runtime || '90');
          const topPx = (start - globalRange.start) * PX_PER_MIN;
          const heightPx = Math.max(runtime * PX_PER_MIN, 24);
          dayCell.appendChild(createMovieElement(movie, true, topPx, heightPx));
        });
      } else {
        dayMovies.forEach(movie => {
          dayCell.appendChild(createMovieElement(movie, false));
        });
      }
    });
  }

  // Initialize
  document.getElementById('week-start-toggle')?.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    document.body.classList.toggle('monday-start', checked);
    document.body.classList.toggle('sunday-start', !checked);
  });

  document.getElementById('duration-mode-toggle')?.addEventListener('change', () => {
    renderAllDays();
  });

  // Fetch and render
  fetch('/tenement-stories-evenings.json')
    .then(res => res.json())
    .then((movies: Movie[]) => {
      movies.forEach(movie => {
        const date = movie.Datetime.split('T')[0];
        if (!moviesByDate[date]) moviesByDate[date] = [];
        moviesByDate[date].push(movie);
      });

      // Calculate global time range
      Object.values(moviesByDate).forEach(dayMovies => {
        const range = getDayTimeRange(dayMovies);
        if (range.start < globalRange.start) globalRange.start = range.start;
        if (range.end > globalRange.end) globalRange.end = range.end;
      });
      globalRange.range = globalRange.end - globalRange.start;
      uniformHeight = Math.max(globalRange.range * PX_PER_MIN, 100) + 32;

      renderAllDays();
    });
</script>

<style>
  /* Day number styles (for dynamically recreated elements) */
  :global(.day-number) {
    font-size: 12px;
    font-weight: 300;
    color: var(--text-tertiary);
    margin-bottom: 8px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    text-transform: uppercase;
    letter-spacing: -0.005em;
  }

  @media (min-width: 480px) {
    :global(.day-number) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      text-transform: none;
      letter-spacing: normal;
      font-weight: 400;
    }
  }

  :global(.day.has-movies .day-number) {
    color: var(--text-secondary);
  }

  :global(.day.timeline-view .day-number) {
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 20;
    margin-bottom: 0;
  }

  /* Client-side injected movie styles */
  :global(.movie) {
    background: var(--bg-movie);
    border-radius: 0;
    margin: 0 0 4px 0;
    font-size: 12px;
    line-height: 1;
    border-left: none;
  }

  @media (min-width: 480px) {
    :global(.movie) {
      font-size: 13px;
    }
  }

  :global(.movie a) {
    display: block;
    padding: 4px;
    color: var(--text-primary);
    text-decoration: none;
  }

  :global(.movie a:hover) {
    background: var(--bg-movie-hover);
  }

  :global(.movie-time) {
    color: var(--accent);
    font-weight: 400;
    margin-right: 3px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.015em;
    text-transform: uppercase;
  }

  :global(.movie-title) {
    font-weight: 400;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.005em;
    text-transform: uppercase;
  }

  @media (min-width: 640px) {
    :global(.movie) {
      line-height: 1;
    }
    :global(.movie-time),
    :global(.movie-title) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      letter-spacing: normal;
      font-weight: 500;
      text-transform: none;
    }
  }

  :global(.movie-meta) {
    color: var(--text-tertiary);
    font-size: 0.85em;
    margin-top: 0.25em;
    line-height: 1.05;
    font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: none;
  }

  @media (min-width: 640px) {
    :global(.movie-meta) {
      display: block;
    }
  }

  :global(.movie-actors) {
    display: none;
    font-style: italic;
    margin-top: 0.3em;
  }

  @media (min-width: 1024px) {
    :global(.movie-actors) {
      display: block;
    }
  }

  :global(.movie--timeline) {
    position: absolute;
    left: 0;
    right: 0;
    overflow: hidden;
    z-index: 1;
    margin-bottom: 0;
  }

  @media (min-width: 1024px) {
    :global(.movie--timeline) {
      left: 4px;
      right: 4px;
    }
  }

  :global(.movie--timeline a) {
    height: 100%;
  }

  :global(.movie--timeline.overlap-col-1) {
    left: 52% !important;
    right: 4px !important;
  }

  :global(.movie--timeline.overlap-col-0.has-overlap) {
    right: 52% !important;
    left: 4px !important;
  }
</style>
