---
import Layout from '../layouts/Layout.astro';
import CalendarGrid from '../components/CalendarGrid.astro';
import DayCell from '../components/DayCell.astro';
import MovieModal from '../components/MovieModal.astro';
import ToggleGroup from '../components/ToggleGroup.astro';
import Switch from '../components/Switch.astro';

// Generate Feb 2026 dates
const dates: string[] = [];
for (let i = 1; i <= 28; i++) {
  dates.push(`2026-02-${i.toString().padStart(2, '0')}`);
}
---

<Layout title="Tenement Stories - Film Forum Feb 2026">
  <h1>Tenement Stories: Timeline View</h1>
  <p class="subtitle">Film Forum, NYC, February 2026</p>

  <div class="controls">
    <div class="control-group">
      <span class="control-group-label">Calendar Display</span>
      <div class="control-group-toggles">
        <Switch id="week-start-toggle" label="Start week on Monday" checked small />
        <Switch id="timeline-mode-toggle" label="Timeline mode" checked small />
        <Switch id="fit-width-toggle" label="Fit to width" checked small />
      </div>
    </div>
    <div class="control-group">
      <span class="control-group-label">Movie Tile Display</span>
      <div class="checkbox-row disabled" id="tile-display-options">
        <span class="checkbox-row-label">Show:</span>
        <label class="checkbox-option">
          <input type="checkbox" id="show-year-director" />
          <span>Year / Director</span>
        </label>
        <label class="checkbox-option">
          <input type="checkbox" id="show-runtime" />
          <span>Runtime</span>
        </label>
        <label class="checkbox-option">
          <input type="checkbox" id="show-actors" />
          <span>Actors</span>
        </label>
        <label class="checkbox-option">
          <input type="checkbox" id="show-image" />
          <span>Image</span>
        </label>
      </div>
    </div>
    <div class="control-group">
      <span class="control-group-label">Filtering</span>
      <div class="control-group-toggles">
        <ToggleGroup
          label="Availability:"
          name="hours-filter-mode"
          options={[
            { label: 'All', value: 'none', checked: true },
            { label: 'After 5pm & weekends', value: 'afterhours' },
            { label: 'Weekends only', value: 'weekends' }
          ]}
          statusId="hours-filter-status"
        />
        <Switch id="highlight-alternate-toggle" label="Highlight alternate showtimes on hover" small />
        <ToggleGroup
          label="Single showings:"
          name="single-showtimes-mode"
          options={[
            { label: 'Off', value: 'none', checked: true },
            { label: '★ Highlight unique', value: 'highlight' },
            { label: 'Only show unique', value: 'only' }
          ]}
        />
      </div>
    </div>
  </div>

  <CalendarGrid>
    {dates.map(date => (
      <DayCell date={date} />
    ))}
  </CalendarGrid>

  <p class="legend">Click any movie for details. Times are PM unless marked "FF Jr."</p>

  <MovieModal />

  <!-- Hidden Movies Modal -->
  <div id="hidden-movies-modal" class="hidden-modal" data-show="">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <button class="modal-close" data-id="close" aria-label="Close">&times;</button>
      <h2>Hidden Weekday 9-5 Showtimes</h2>
      <p class="hidden-modal-subtitle">These showtimes are hidden because they fall during weekday work hours (9am-5pm).</p>
      <div id="hidden-movies-list" class="hidden-movies-list"></div>
    </div>
  </div>

  <!-- Weekday Movies Modal (for weekends-only filter) -->
  <div id="weekday-movies-modal" class="hidden-modal" data-show="">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <button class="modal-close" data-id="close" aria-label="Close">&times;</button>
      <h2>Hidden Weekday Showtimes</h2>
      <p class="hidden-modal-subtitle">These showtimes are hidden because they fall on weekdays (Mon-Fri).</p>
      <div id="weekday-movies-list" class="hidden-movies-list"></div>
    </div>
  </div>

  <!-- Confirm Disable Fit-Width Modal -->
  <div id="confirm-fit-width-modal" class="hidden-modal" data-show="">
    <div class="modal-overlay"></div>
    <div class="modal-content confirm-modal-content">
      <h2>Show Movie Details?</h2>
      <p class="hidden-modal-subtitle">Disable "Fit to width" to show additional movie details like year, director, runtime, and images.</p>
      <div class="confirm-buttons">
        <button id="confirm-fit-width-cancel" class="confirm-btn confirm-btn-cancel">Cancel</button>
        <button id="confirm-fit-width-ok" class="confirm-btn confirm-btn-ok">Disable Fit to Width</button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import {
    DAYS,
    PX_PER_MIN,
    WORK_START,
    WORK_END,
    HOURS_FILTER_MODE,
    SINGLE_SHOWTIMES_MODE,
    type HoursFilterMode,
    type SingleShowtimesMode,
  } from '../constants';
  import { downloadICS, type Movie } from '../utils/icsGenerator';

  let moviesByDate: Record<string, Movie[]> = {};
  let globalRange = { start: Infinity, end: 0, range: 0 };
  let uniformHeight = 0;
  let movieShowtimeCounts: Record<string, number> = {};
  let allMovies: Movie[] = [];

  function toTitleCase(str: string) {
    return str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
  }

  function processFFJr(time: string, title: string): { displayTime: string; displayTitle: string } {
    const isFFJr = time.includes('FF Jr');
    const displayTime = isFFJr ? time.replace(/\s*[–-]?\s*FF Jr\.?/g, '').trim() : time;
    const displayTitle = isFFJr ? `${toTitleCase(title)} (FF Jr.)` : toTitleCase(title);
    return { displayTime, displayTitle };
  }

  function parseTimeToMins(timeStr: string) {
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (!match) return 0;
    let h = parseInt(match[1]);
    const m = parseInt(match[2]);
    // FF Jr. shows are morning (AM)
    const isMorning = timeStr.includes('FF Jr');
    // 12:XX is always noon (PM), 1-11 without FF Jr are PM
    if (!isMorning && h !== 12 && h < 12) h += 12;
    return h * 60 + m;
  }

  function getDayTimeRange(movies: Movie[]) {
    let minStart = Infinity, maxEnd = 0;
    movies.forEach(m => {
      const start = parseTimeToMins(m.Time);
      const runtime = parseInt(m.runtime || '90');
      const end = start + runtime;
      if (start < minStart) minStart = start;
      if (end > maxEnd) maxEnd = end;
    });
    return { start: minStart, end: maxEnd, range: maxEnd - minStart };
  }

  function assignOverlapColumns(movies: Movie[]) {
    const sorted = [...movies].sort((a, b) => parseTimeToMins(a.Time) - parseTimeToMins(b.Time));
    sorted.forEach((movie, i) => {
      movie._col = 0;
      movie._hasOverlap = false;
      const myStart = parseTimeToMins(movie.Time);
      for (let j = 0; j < i; j++) {
        const prev = sorted[j];
        const prevEnd = parseTimeToMins(prev.Time) + parseInt(prev.runtime || '90');
        if (prevEnd > myStart) {
          movie._col = 1;
          prev._hasOverlap = true;
          movie._hasOverlap = true;
          break;
        }
      }
    });
    return sorted;
  }

  function createMovieElement(movie: Movie, isTimeline: boolean, topPx?: number, heightPx?: number, filteredCounts?: Record<string, number>, singleMode?: SingleShowtimesMode) {
    const el = document.createElement('div');
    const classes = ['movie'];
    if (isTimeline) {
      classes.push('movie--timeline');
      if (movie._col === 1) classes.push('overlap-col-1');
      else if (movie._hasOverlap) classes.push('overlap-col-0', 'has-overlap');
    }
    el.className = classes.join(' ');

    if (isTimeline && topPx !== undefined && heightPx !== undefined) {
      el.style.top = `${topPx + 28}px`;
      el.style.height = `${heightPx}px`;
    }

    // Set poster as background for timeline mode
    if (isTimeline && movie.poster_url) {
      el.style.backgroundImage = `url(${movie.poster_url})`;
      el.classList.add('has-poster');
    }

    const yearDirector = [movie.year, movie.director].filter(Boolean).join(', ');
    const runtime = movie.runtime ? movie.runtime.replace(' minutes', 'min').replace(' ', '') : '';
    const actors = movie.actors ? movie.actors.split(',').slice(0, 3).map(a => a.trim()).join(', ') : '';

    // Store movie data for modal
    el.dataset.movie = JSON.stringify(movie);
    el.setAttribute('tabindex', '0');
    el.setAttribute('role', 'button');

    const isSingleShowtime = filteredCounts && filteredCounts[movie.Movie] === 1;
    const badgeHtml = (singleMode === SINGLE_SHOWTIMES_MODE.HIGHLIGHT && isSingleShowtime)
      ? '<span class="single-showtime-badge" title="Only showtime with current filters">★</span>'
      : '';

    const posterHtml = movie.poster_url
      ? `<img class="movie-poster" src="${movie.poster_url}" alt="" loading="lazy" />`
      : '';

    // Process FF Jr. designation: move from time to title prefix
    const { displayTime, displayTitle } = processFFJr(movie.Time, movie.Movie);

    el.innerHTML = `
      ${badgeHtml}
      <div class="movie-clickable">
        ${posterHtml}
        <span class="movie-time">${displayTime}</span>
        <span class="movie-title">${displayTitle}</span>
        <div class="movie-meta">
          ${yearDirector ? `<span class="movie-year-director">${yearDirector}</span>` : ''}
          ${runtime ? `<span class="movie-runtime">${runtime}</span>` : ''}
          ${actors ? `<span class="movie-actors">${actors}</span>` : ''}
        </div>
      </div>
    `;
    return el;
  }

  function getHiddenWorkHoursMovies(): Movie[] {
    return allMovies.filter(movie => {
      const date = movie.Datetime.split('T')[0];
      const dayOfWeek = new Date(date + 'T12:00:00').getDay();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      if (!isWeekday) return false;
      const mins = parseTimeToMins(movie.Time);
      return mins >= WORK_START && mins < WORK_END;
    });
  }

  function getWeekdayMovies(): Movie[] {
    return allMovies.filter(movie => {
      const date = movie.Datetime.split('T')[0];
      const dayOfWeek = new Date(date + 'T12:00:00').getDay();
      return dayOfWeek >= 1 && dayOfWeek <= 5;
    });
  }

  function updateHoursFilterStatus(mode: HoursFilterMode) {
    const statusEl = document.getElementById('hours-filter-status');
    if (!statusEl) return;

    if (mode === HOURS_FILTER_MODE.NONE) {
      statusEl.textContent = '';
      statusEl.style.display = 'none';
      return;
    }

    const hiddenMovies = mode === HOURS_FILTER_MODE.WEEKENDS ? getWeekdayMovies() : getHiddenWorkHoursMovies();
    const uniqueTitles = new Set(hiddenMovies.map(m => m.Movie));
    statusEl.textContent = `(${hiddenMovies.length} showtimes, ${uniqueTitles.size} films hidden)`;
    statusEl.style.display = 'inline';
  }

  function renderAllDays() {
    const timelineMode = (document.getElementById('timeline-mode-toggle') as HTMLInputElement).checked;

    // Get hours filter mode
    const hoursFilterRadio = document.querySelector('input[name="hours-filter-mode"]:checked') as HTMLInputElement;
    const hoursFilterMode = (hoursFilterRadio?.value || HOURS_FILTER_MODE.NONE) as HoursFilterMode;

    // Get single showtimes mode
    const singleShowtimesRadio = document.querySelector('input[name="single-showtimes-mode"]:checked') as HTMLInputElement;
    const singleShowtimesMode = (singleShowtimesRadio?.value || SINGLE_SHOWTIMES_MODE.NONE) as SingleShowtimesMode;

    updateHoursFilterStatus(hoursFilterMode);

    // Build count of filtered showtimes per movie title
    const filteredShowtimeCounts: Record<string, number> = {};
    Object.entries(moviesByDate).forEach(([date, dayMovies]) => {
      // Apply same filter logic to count
      const dayOfWeek = new Date(date + 'T12:00:00').getDay();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      let filtered = dayMovies;
      if (hoursFilterMode === HOURS_FILTER_MODE.WEEKENDS && isWeekday) {
        filtered = [];
      } else if (hoursFilterMode === HOURS_FILTER_MODE.AFTERHOURS && isWeekday) {
        filtered = dayMovies.filter(m => {
          const mins = parseTimeToMins(m.Time);
          return mins < WORK_START || mins >= WORK_END;
        });
      }
      filtered.forEach(m => {
        filteredShowtimeCounts[m.Movie] = (filteredShowtimeCounts[m.Movie] || 0) + 1;
      });
    });

    Object.entries(moviesByDate).forEach(([date, dayMovies]) => {
      // Check if this date is a weekday (Mon-Fri = 1-5, Sat = 6, Sun = 0)
      const dayOfWeek = new Date(date + 'T12:00:00').getDay();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;

      // Apply filters
      let filteredMovies = dayMovies;

      // Weekends only filter - hide all weekday movies
      if (hoursFilterMode === HOURS_FILTER_MODE.WEEKENDS && isWeekday) {
        filteredMovies = [];
      }
      // After 5pm filter - hide 9-5 on weekdays
      else if (hoursFilterMode === HOURS_FILTER_MODE.AFTERHOURS && isWeekday) {
        filteredMovies = dayMovies.filter(m => {
          const mins = parseTimeToMins(m.Time);
          return mins < WORK_START || mins >= WORK_END;
        });
      }

      // If "only show" mode, filter to single-showtime movies only
      if (singleShowtimesMode === SINGLE_SHOWTIMES_MODE.ONLY) {
        filteredMovies = filteredMovies.filter(m => filteredShowtimeCounts[m.Movie] === 1);
      }

      const dayCell = document.querySelector(`[data-date="${date}"]`) as HTMLElement;
      if (!dayCell) return;

      // Clear and reset
      const dayNumber = dayCell.dataset.dayNumber;
      dayCell.innerHTML = '';
      dayCell.classList.remove('timeline-view');
      dayCell.classList.add('has-movies');
      dayCell.style.height = '';

      // Re-add day number
      const dayNumDiv = document.createElement('div');
      dayNumDiv.className = 'day-number';
      dayNumDiv.textContent = dayNumber || '';
      dayCell.appendChild(dayNumDiv);

      if (filteredMovies.length === 0) {
        dayCell.classList.remove('has-movies');
        return;
      }

      if (timelineMode) {
        dayCell.style.height = `${uniformHeight}px`;
        dayCell.classList.add('timeline-view');
        const sorted = assignOverlapColumns(filteredMovies);
        sorted.forEach(movie => {
          const start = parseTimeToMins(movie.Time);
          const runtime = parseInt(movie.runtime || '90');
          const topPx = (start - globalRange.start) * PX_PER_MIN;
          const heightPx = Math.max(runtime * PX_PER_MIN, 24);
          dayCell.appendChild(createMovieElement(movie, true, topPx, heightPx, filteredShowtimeCounts, singleShowtimesMode));
        });
      } else {
        filteredMovies.forEach(movie => {
          dayCell.appendChild(createMovieElement(movie, false, undefined, undefined, filteredShowtimeCounts, singleShowtimesMode));
        });
      }
    });
  }

  // Initialize
  document.getElementById('week-start-toggle')?.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    document.body.classList.toggle('monday-start', checked);
    document.body.classList.toggle('sunday-start', !checked);
    updateUrlParams();
  });

  document.getElementById('timeline-mode-toggle')?.addEventListener('change', () => {
    renderAllDays();
    updateUrlParams();
  });

  // Movie Tile Display checkboxes - interdependent with fit-width
  const fitWidthToggle = document.getElementById('fit-width-toggle');
  const tileDisplayOptions = document.getElementById('tile-display-options');
  const showYearDirector = document.getElementById('show-year-director') as HTMLInputElement;
  const showRuntime = document.getElementById('show-runtime') as HTMLInputElement;
  const showActors = document.getElementById('show-actors') as HTMLInputElement;
  const showImage = document.getElementById('show-image') as HTMLInputElement;

  function getToggleInput(el: HTMLElement | null): HTMLInputElement | null {
    if (!el) return null;
    return el.tagName === 'INPUT' ? el as HTMLInputElement : el.querySelector('input');
  }

  function updateUrlParams() {
    const params = new URLSearchParams();

    // Timeline mode
    const timelineInput = getToggleInput(document.getElementById('timeline-mode-toggle'));
    if (timelineInput) params.set('timeline', timelineInput.checked ? '1' : '0');

    // Fit to width
    const fitWidthInput = getToggleInput(document.getElementById('fit-width-toggle'));
    if (fitWidthInput) params.set('fit-width', fitWidthInput.checked ? '1' : '0');

    // Week start
    const weekStartInput = getToggleInput(document.getElementById('week-start-toggle'));
    if (weekStartInput) params.set('week-start', weekStartInput.checked ? '1' : '0');

    // Tile display checkboxes
    const imageCheck = document.getElementById('show-image') as HTMLInputElement;
    if (imageCheck?.checked) params.set('image', '1');

    const ydCheck = document.getElementById('show-year-director') as HTMLInputElement;
    if (ydCheck?.checked) params.set('year-director', '1');

    const runtimeCheck = document.getElementById('show-runtime') as HTMLInputElement;
    if (runtimeCheck?.checked) params.set('runtime', '1');

    const actorsCheck = document.getElementById('show-actors') as HTMLInputElement;
    if (actorsCheck?.checked) params.set('actors', '1');

    // Filters
    const hoursFilter = document.querySelector('input[name="hours-filter-mode"]:checked') as HTMLInputElement;
    if (hoursFilter?.value && hoursFilter.value !== 'none') params.set('hours', hoursFilter.value);

    const singleFilter = document.querySelector('input[name="single-showtimes-mode"]:checked') as HTMLInputElement;
    if (singleFilter?.value && singleFilter.value !== 'none') params.set('single', singleFilter.value);

    const newUrl = params.toString() ? `${window.location.pathname}?${params}` : window.location.pathname;
    history.replaceState(null, '', newUrl);
  }

  function updateTileDisplayState() {
    const fitWidthInput = getToggleInput(fitWidthToggle);
    const fitWidthEnabled = fitWidthInput?.checked ?? true;

    if (fitWidthEnabled) {
      // Disable checkboxes and clear their state
      tileDisplayOptions?.classList.add('disabled');
      [showYearDirector, showRuntime, showActors, showImage].forEach(cb => {
        if (cb) cb.checked = false;
      });
      document.body.classList.remove('show-year-director', 'show-runtime', 'show-actors', 'show-image',
        'hide-year-director', 'hide-runtime', 'hide-actors', 'hide-image');
    } else {
      tileDisplayOptions?.classList.remove('disabled');
    }
  }

  fitWidthToggle?.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    document.body.classList.toggle('natural-width', !checked);
    updateTileDisplayState();
    updateUrlParams();
  });

  // Handle click on disabled checkbox row - use custom modal
  let pendingCheckbox: HTMLInputElement | null = null;
  const confirmModal = document.getElementById('confirm-fit-width-modal');
  const confirmOkBtn = document.getElementById('confirm-fit-width-ok');
  const confirmCancelBtn = document.getElementById('confirm-fit-width-cancel');
  const confirmOverlay = confirmModal?.querySelector('.modal-overlay');

  function showConfirmModal(checkbox: HTMLInputElement) {
    pendingCheckbox = checkbox;
    if (confirmModal) confirmModal.dataset.show = 'true';
  }

  function hideConfirmModal() {
    if (confirmModal) confirmModal.dataset.show = '';
    pendingCheckbox = null;
  }

  confirmOkBtn?.addEventListener('click', () => {
    const fitWidthInput = getToggleInput(fitWidthToggle);
    if (fitWidthInput) {
      fitWidthInput.checked = false;
      fitWidthInput.dispatchEvent(new Event('change'));
    }
    // Now toggle the checkbox that was originally clicked
    if (pendingCheckbox) {
      pendingCheckbox.checked = true;
      pendingCheckbox.dispatchEvent(new Event('change'));
    }
    hideConfirmModal();
  });

  confirmCancelBtn?.addEventListener('click', hideConfirmModal);
  confirmOverlay?.addEventListener('click', hideConfirmModal);

  tileDisplayOptions?.addEventListener('click', (e) => {
    if (tileDisplayOptions.classList.contains('disabled')) {
      const fitWidthInput = getToggleInput(fitWidthToggle);
      if (fitWidthInput?.checked) {
        // Find which checkbox was clicked
        const clickedLabel = (e.target as HTMLElement).closest('.checkbox-option');
        const clickedCheckbox = clickedLabel?.querySelector('input') as HTMLInputElement;
        if (clickedCheckbox) {
          showConfirmModal(clickedCheckbox);
        }
      }
    }
  });

  // Checkbox change handlers - toggle both show and hide classes
  showYearDirector?.addEventListener('change', () => {
    document.body.classList.toggle('show-year-director', showYearDirector.checked);
    document.body.classList.toggle('hide-year-director', !showYearDirector.checked);
    updateUrlParams();
  });

  showRuntime?.addEventListener('change', () => {
    document.body.classList.toggle('show-runtime', showRuntime.checked);
    document.body.classList.toggle('hide-runtime', !showRuntime.checked);
    updateUrlParams();
  });

  showActors?.addEventListener('change', () => {
    document.body.classList.toggle('show-actors', showActors.checked);
    document.body.classList.toggle('hide-actors', !showActors.checked);
    updateUrlParams();
  });

  showImage?.addEventListener('change', () => {
    document.body.classList.toggle('show-image', showImage.checked);
    document.body.classList.toggle('hide-image', !showImage.checked);
    updateUrlParams();
  });

  // Initialize tile display state
  updateTileDisplayState();

  document.querySelectorAll('input[name="hours-filter-mode"]').forEach(radio => {
    radio.addEventListener('change', () => {
      renderAllDays();
      updateUrlParams();
    });
  });

  document.querySelectorAll('input[name="single-showtimes-mode"]').forEach(radio => {
    radio.addEventListener('change', () => {
      renderAllDays();
      updateUrlParams();
    });
  });

  // Fetch and render
  fetch('/tenement-stories-full.json')
    .then(res => res.json())
    .then((movies: Movie[]) => {
      allMovies = movies;
      movies.forEach(movie => {
        const date = movie.Datetime.split('T')[0];
        if (!moviesByDate[date]) moviesByDate[date] = [];
        moviesByDate[date].push(movie);
      });

      // Build count of showtimes per movie title
      movies.forEach(movie => {
        movieShowtimeCounts[movie.Movie] = (movieShowtimeCounts[movie.Movie] || 0) + 1;
      });

      // Calculate global time range
      Object.values(moviesByDate).forEach(dayMovies => {
        const range = getDayTimeRange(dayMovies);
        if (range.start < globalRange.start) globalRange.start = range.start;
        if (range.end > globalRange.end) globalRange.end = range.end;
      });
      globalRange.range = globalRange.end - globalRange.start;
      uniformHeight = Math.max(globalRange.range * PX_PER_MIN, 100) + 32;

      renderAllDays();
    });

  // Modal management
  let modalDOM: HTMLElement | null = null;
  let overlayDOM: HTMLElement | null = null;

  function initModal() {
    modalDOM = document.getElementById('movie-modal');
    if (modalDOM) {
      overlayDOM = modalDOM.querySelector('.modal-overlay') as HTMLElement;

      // Close button handler
      const closeBtn = modalDOM.querySelector('[data-id="close"]');
      closeBtn?.addEventListener('click', closeModal);

      // Overlay click handler
      overlayDOM?.addEventListener('click', closeModal);

      // Escape key handler
      document.addEventListener('keydown', (e) => {
        if (modalDOM?.dataset.show === 'true' && e.key === 'Escape') {
          closeModal();
        }
      });
    }
  }

  function openModal() {
    if (modalDOM) {
      modalDOM.dataset.show = 'true';
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal() {
    if (modalDOM) {
      modalDOM.dataset.show = '';
      document.body.style.overflow = '';
    }
  }

  function formatDateTime(datetime: string) {
    const date = new Date(datetime);
    return date.toLocaleString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function formatShowtime(datetime: string) {
    const date = new Date(datetime);
    return date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function openMovieModal(movie: Movie) {
    const titleEl = document.getElementById('modal-title');
    const metaEl = document.getElementById('modal-meta');
    const actorsEl = document.getElementById('modal-actors');
    const descEl = document.getElementById('modal-description');
    const ticketsEl = document.getElementById('modal-buy-tickets') as HTMLAnchorElement;
    const disclaimerEl = document.getElementById('modal-disclaimer');
    const calendarBtn = document.getElementById('modal-add-calendar');
    const posterEl = document.getElementById('modal-poster') as HTMLImageElement;
    const posterPlaceholder = document.querySelector('.poster-placeholder') as HTMLElement;

    // Set poster image
    if (posterEl && posterPlaceholder) {
      if (movie.poster_url) {
        posterEl.src = movie.poster_url;
        posterEl.alt = movie.Movie;
        posterEl.style.display = 'block';
        posterPlaceholder.style.display = 'none';
      } else {
        posterEl.style.display = 'none';
        posterPlaceholder.style.display = 'block';
      }
    }

    if (titleEl) titleEl.textContent = toTitleCase(movie.Movie);

    if (metaEl) {
      const runtime = movie.runtime?.replace(' minutes', 'min') || '';
      metaEl.textContent = [movie.year, movie.director, runtime].filter(Boolean).join(' · ');
    }

    if (actorsEl) {
      if (movie.actors) {
        const actorSpans = movie.actors.split(',').map(a => `<span>${a.trim()}</span>`).join(', ');
        actorsEl.innerHTML = `<span class="starring-label">Starring:</span> ${actorSpans}`;
        actorsEl.style.display = 'block';
      } else {
        actorsEl.style.display = 'none';
      }
    }

    if (descEl) {
      descEl.textContent = movie.description || 'No description available.';
    }

    if (ticketsEl) {
      ticketsEl.href = movie.Tickets;
    }

    if (disclaimerEl) {
      const date = new Date(movie.Datetime);
      const showtime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }).replace(' ', '');
      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      disclaimerEl.textContent = `When buying, select ${showtime} on ${dateStr}:`;
    }

    // Set up calendar button
    if (calendarBtn) {
      calendarBtn.onclick = () => downloadICS(movie);
    }

    // Set up film page link
    const filmPageEl = document.getElementById('modal-film-page') as HTMLAnchorElement;
    if (filmPageEl) {
      if (movie.film_url) {
        filmPageEl.href = movie.film_url;
        filmPageEl.style.display = 'block';
      } else {
        filmPageEl.style.display = 'none';
      }
    }

    openModal();
  }

  // Hidden movies modal management
  let hiddenModalDOM: HTMLElement | null = null;
  let weekdayModalDOM: HTMLElement | null = null;

  function initHiddenModals() {
    // Work hours modal
    hiddenModalDOM = document.getElementById('hidden-movies-modal');
    if (hiddenModalDOM) {
      const overlay = hiddenModalDOM.querySelector('.modal-overlay');
      const closeBtn = hiddenModalDOM.querySelector('[data-id="close"]');
      closeBtn?.addEventListener('click', () => closeHiddenModal(hiddenModalDOM!));
      overlay?.addEventListener('click', () => closeHiddenModal(hiddenModalDOM!));
    }

    // Weekday modal
    weekdayModalDOM = document.getElementById('weekday-movies-modal');
    if (weekdayModalDOM) {
      const overlay = weekdayModalDOM.querySelector('.modal-overlay');
      const closeBtn = weekdayModalDOM.querySelector('[data-id="close"]');
      closeBtn?.addEventListener('click', () => closeHiddenModal(weekdayModalDOM!));
      overlay?.addEventListener('click', () => closeHiddenModal(weekdayModalDOM!));
    }

    // Escape key handler for both modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (hiddenModalDOM?.dataset.show === 'true') closeHiddenModal(hiddenModalDOM);
        if (weekdayModalDOM?.dataset.show === 'true') closeHiddenModal(weekdayModalDOM);
      }
    });

    // Status click handler
    document.getElementById('hours-filter-status')?.addEventListener('click', () => {
      const hoursFilterRadio = document.querySelector('input[name="hours-filter-mode"]:checked') as HTMLInputElement;
      const mode = hoursFilterRadio?.value || 'none';
      if (mode === 'weekends') {
        openWeekdayModal();
      } else if (mode === 'afterhours') {
        openWorkHoursModal();
      }
    });
  }

  function renderMovieList(movies: Movie[]): string {
    // Group by movie title
    const byTitle: Record<string, Movie[]> = {};
    movies.forEach(m => {
      if (!byTitle[m.Movie]) byTitle[m.Movie] = [];
      byTitle[m.Movie].push(m);
    });

    // Sort by title
    const sortedTitles = Object.keys(byTitle).sort();

    return sortedTitles.map(title => {
      const titleMovies = byTitle[title];
      const showtimes = titleMovies.map(m => {
        const date = new Date(m.Datetime);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const { displayTime } = processFFJr(m.Time, m.Movie);
        return `<span class="hidden-showtime">${dayName} ${dateStr} ${displayTime}</span>`;
      }).join('');
      const meta = [titleMovies[0].year, titleMovies[0].director].filter(Boolean).join(', ');
      // Check if any showtime has FF Jr. to add prefix to title
      const hasFFJr = titleMovies.some(m => m.Time.includes('FF Jr'));
      const displayTitle = hasFFJr ? `${toTitleCase(title)} (FF Jr.)` : toTitleCase(title);
      return `<div class="hidden-movie-item"><span class="hidden-movie-title">${displayTitle}</span>${meta ? `<span class="hidden-movie-meta">(${meta})</span>` : ''}<span class="hidden-movie-showtimes">— ${showtimes}</span></div>`;
    }).join('');
  }

  function openWorkHoursModal() {
    if (!hiddenModalDOM) return;
    const listEl = document.getElementById('hidden-movies-list');
    if (!listEl) return;

    listEl.innerHTML = renderMovieList(getHiddenWorkHoursMovies());
    hiddenModalDOM.dataset.show = 'true';
    document.body.style.overflow = 'hidden';
  }

  function openWeekdayModal() {
    if (!weekdayModalDOM) return;
    const listEl = document.getElementById('weekday-movies-list');
    if (!listEl) return;

    listEl.innerHTML = renderMovieList(getWeekdayMovies());
    weekdayModalDOM.dataset.show = 'true';
    document.body.style.overflow = 'hidden';
  }

  function closeHiddenModal(modal: HTMLElement) {
    modal.dataset.show = '';
    document.body.style.overflow = '';
  }

  // Event delegation for movie clicks
  document.addEventListener('DOMContentLoaded', () => {
    initModal();
    initHiddenModals();

    // Parse URL parameters to set view state (enables reliable screenshot testing)
    const params = new URLSearchParams(window.location.search);

    if (params.has('timeline')) {
      const timelineToggle = document.querySelector('#timeline-mode-toggle input') as HTMLInputElement;
      const wantTimeline = params.get('timeline') === '1';
      if (timelineToggle && timelineToggle.checked !== wantTimeline) timelineToggle.click();
    }

    if (params.has('fit-width')) {
      const fitWidthToggle = document.querySelector('#fit-width-toggle input') as HTMLInputElement;
      const wantFitWidth = params.get('fit-width') === '1';
      if (fitWidthToggle && fitWidthToggle.checked !== wantFitWidth) fitWidthToggle.click();
    }

    if (params.has('week-start')) {
      const weekStartToggle = document.querySelector('#week-start-toggle input') as HTMLInputElement;
      const wantWeekStart = params.get('week-start') === '1';
      if (weekStartToggle && weekStartToggle.checked !== wantWeekStart) weekStartToggle.click();
    }

    // For checkboxes: image, year-director, runtime, actors
    ['image', 'year-director', 'runtime', 'actors'].forEach(key => {
      if (params.has(key)) {
        const id = key === 'year-director' ? 'show-year-director' : `show-${key}`;
        const cb = document.getElementById(id) as HTMLInputElement;
        if (cb && cb.checked !== (params.get(key) === '1')) cb.click();
      }
    });

    // Filters
    if (params.has('hours')) {
      const hoursValue = params.get('hours');
      const radio = document.querySelector(`input[name="hours-filter-mode"][value="${hoursValue}"]`) as HTMLInputElement;
      if (radio) radio.click();
    }

    if (params.has('single')) {
      const singleValue = params.get('single');
      const radio = document.querySelector(`input[name="single-showtimes-mode"][value="${singleValue}"]`) as HTMLInputElement;
      if (radio) radio.click();
    }

    document.querySelector('.calendar')?.addEventListener('click', (e) => {
      const movieEl = (e.target as HTMLElement).closest('[data-movie]');
      if (movieEl) {
        const movie = JSON.parse((movieEl as HTMLElement).dataset.movie || '{}');
        openMovieModal(movie);
      }
    });

    // Keyboard accessibility
    document.querySelector('.calendar')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const movieEl = (e.target as HTMLElement).closest('[data-movie]');
        if (movieEl) {
          e.preventDefault();
          const movie = JSON.parse((movieEl as HTMLElement).dataset.movie || '{}');
          openMovieModal(movie);
        }
      }
    });

    // Highlight alternate showtimes on hover
    let currentHighlightedMovie: string | null = null;

    document.querySelector('.calendar')?.addEventListener('mouseover', (e) => {
      const movieEl = (e.target as HTMLElement).closest('[data-movie]');
      if (!movieEl) return;

      const highlightToggleEl = document.getElementById('highlight-alternate-toggle');
      const highlightEnabled = highlightToggleEl?.tagName === 'INPUT'
        ? (highlightToggleEl as HTMLInputElement).checked
        : (highlightToggleEl?.querySelector('input') as HTMLInputElement)?.checked;
      if (!highlightEnabled) return;

      const movie = JSON.parse((movieEl as HTMLElement).dataset.movie || '{}');
      if (movieShowtimeCounts[movie.Movie] <= 1) return;

      // Avoid re-processing if already highlighting this movie
      if (currentHighlightedMovie === movie.Movie) return;
      currentHighlightedMovie = movie.Movie;

      // Remove existing highlights first
      document.querySelectorAll('.alternate-highlight').forEach(el => {
        el.classList.remove('alternate-highlight');
      });

      // Highlight all movies with the same title
      document.querySelectorAll('[data-movie]').forEach(el => {
        const otherMovie = JSON.parse((el as HTMLElement).dataset.movie || '{}');
        if (otherMovie.Movie === movie.Movie) {
          el.classList.add('alternate-highlight');
        }
      });
    });

    document.querySelector('.calendar')?.addEventListener('mouseout', (e) => {
      const movieEl = (e.target as HTMLElement).closest('[data-movie]');
      const relatedTarget = (e as MouseEvent).relatedTarget as HTMLElement | null;
      const relatedMovieEl = relatedTarget?.closest('[data-movie]');

      // Only remove highlights if leaving the movie tile entirely
      if (movieEl && (!relatedMovieEl || relatedMovieEl !== movieEl)) {
        currentHighlightedMovie = null;
        document.querySelectorAll('.alternate-highlight').forEach(el => {
          el.classList.remove('alternate-highlight');
        });
      }
    });
  });
</script>

<style>
  /* Day number styles (for dynamically recreated elements) */
  :global(.day-number) {
    font-size: 12px;
    font-weight: 300;
    color: var(--text-tertiary);
    margin-bottom: 8px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    text-transform: uppercase;
    letter-spacing: -0.005em;
  }

  @media (min-width: 480px) {
    :global(.day-number) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      text-transform: none;
      letter-spacing: normal;
      font-weight: 400;
    }
  }

  :global(.day.has-movies .day-number) {
    color: var(--text-secondary);
  }

  :global(.day.timeline-view .day-number) {
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 20;
    margin-bottom: 0;
  }

  /* Client-side injected movie styles */
  :global(.movie) {
    position: relative;
    background: var(--bg-movie);
    border-radius: 0;
    margin: 0 0 4px 0;
    font-size: 12px;
    line-height: 1;
    border-left: none;
  }

  @media (min-width: 480px) {
    :global(.movie) {
      font-size: 13px;
    }
  }

  :global(.movie) {
    cursor: pointer;
  }

  :global(.movie:hover),
  :global(.movie:focus) {
    background: var(--bg-movie-hover);
    outline: none;
  }

  :global(.movie:focus-visible) {
    box-shadow: 0 0 0 2px var(--accent);
  }

  :global(.movie-clickable) {
    display: block;
    padding: 4px;
    color: var(--text-primary);
  }

  :global(.movie-time) {
    color: var(--accent);
    font-weight: 400;
    margin-right: 3px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.015em;
    text-transform: uppercase;
  }

  :global(.movie-title) {
    font-weight: 400;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.005em;
    text-transform: uppercase;
  }

  @media (min-width: 640px) {
    :global(.movie) {
      line-height: 1;
    }
    :global(.movie-time),
    :global(.movie-title) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      letter-spacing: normal;
      font-weight: 500;
      text-transform: none;
    }
  }

  :global(.movie-meta) {
    color: var(--text-tertiary);
    font-size: 0.85em;
    margin-top: 0.25em;
    line-height: 1.05;
    font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: none;
  }

  @media (min-width: 640px) {
    :global(.movie-meta) {
      display: block;
    }
  }

  :global(.movie-actors) {
    display: none;
    font-style: italic;
    margin-top: 0.3em;
  }

  @media (min-width: 1024px) {
    :global(.movie-actors) {
      display: block;
    }
  }

  /* Movie meta element base styles */
  :global(.movie-year-director),
  :global(.movie-runtime) {
    display: none;
  }

  :global(.movie-year-director)::after {
    content: ', ';
  }

  :global(.movie-runtime:last-of-type)::before,
  :global(.movie-year-director:last-of-type)::after {
    content: '';
  }

  /* Checkbox-controlled visibility for movie tile display */
  :global(body.show-year-director .movie-meta),
  :global(body.show-runtime .movie-meta),
  :global(body.show-actors .movie-meta) {
    display: block !important;
  }

  :global(body.show-year-director .movie-year-director) {
    display: inline !important;
  }

  :global(body.show-runtime .movie-runtime) {
    display: inline !important;
  }

  :global(body.show-actors .movie-actors) {
    display: block !important;
  }

  /* Hide classes for when checkboxes are explicitly unchecked */
  :global(body.hide-year-director .movie-year-director) {
    display: none !important;
  }

  :global(body.hide-runtime .movie-runtime) {
    display: none !important;
  }

  :global(body.hide-actors .movie-actors) {
    display: none !important;
  }

  :global(body.hide-image .movie-poster) {
    display: none !important;
  }

  :global(.movie-poster) {
    display: none;
    width: calc(100% + 8px);
    margin: -4px -4px 4px -4px;
    height: auto;
    border-radius: 0;
  }

  :global(body.show-image .movie-poster) {
    display: block !important;
  }

  /* Checkbox row styling */
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .checkbox-row-label {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .checkbox-option {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
  }

  .checkbox-option input {
    margin: 0;
  }

  /* Disabled checkbox row styling */
  .checkbox-row.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .checkbox-row.disabled label {
    pointer-events: none;
  }

  :global(.movie--timeline) {
    position: absolute;
    left: 0;
    right: 0;
    overflow: hidden;
    z-index: 1;
    margin-bottom: 0;
  }

  @media (min-width: 1024px) {
    :global(.movie--timeline) {
      left: 4px;
      right: 4px;
    }
  }

  :global(.movie--timeline .movie-clickable) {
    height: 100%;
  }

  :global(.movie--timeline.overlap-col-1) {
    left: 52% !important;
    right: 4px !important;
  }

  :global(.movie--timeline.overlap-col-0.has-overlap) {
    right: 52% !important;
    left: 4px !important;
  }

  :global(.movie.alternate-highlight) {
    outline: 2px solid var(--accent);
    outline-offset: -2px;
  }

  /* Toggle with status wrapper */
  .toggle-with-status {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .hidden-status {
    font-size: 12px;
    color: var(--text-tertiary);
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
  }

  .hidden-status:hover {
    color: var(--accent);
  }


  /* Hidden movies modal */
  :global(.hidden-modal) {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
  }

  :global(.hidden-modal[data-show="true"]) {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.hidden-modal .modal-overlay) {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
  }

  :global(.hidden-modal .modal-content) {
    position: relative;
    background: var(--bg-day);
    border-radius: 8px;
    padding: 24px;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    margin: 16px;
    width: 100%;
  }

  :global(.hidden-modal .modal-close) {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-tertiary);
    cursor: pointer;
    line-height: 1;
    padding: 4px;
  }

  :global(.hidden-modal .modal-close:hover) {
    color: var(--text-primary);
  }

  :global(.hidden-modal h2) {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: var(--text-primary);
  }

  :global(.hidden-modal-subtitle) {
    margin: 0 0 16px 0;
    font-size: 13px;
    color: var(--text-tertiary);
  }

  :global(.hidden-movies-list) {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  :global(.hidden-movie-item) {
    padding: 4px 0;
    border-bottom: 1px solid var(--bg-movie);
  }

  :global(.hidden-movie-item:last-child) {
    border-bottom: none;
  }

  :global(.hidden-movie-title) {
    font-weight: 500;
    color: var(--text-primary);
    display: inline;
  }

  :global(.hidden-movie-meta) {
    font-size: 12px;
    color: var(--text-tertiary);
    display: inline;
    margin-left: 6px;
  }

  :global(.hidden-movie-showtimes) {
    display: inline;
    margin-left: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  :global(.hidden-showtime) {
    color: var(--text-secondary);
  }

  :global(.hidden-showtime:not(:last-child)::after) {
    content: ', ';
  }

  :global(.single-showtime-badge) {
    position: absolute;
    top: 2px;
    right: 4px;
    font-size: 10px;
    color: var(--accent);
    z-index: 5;
  }

  /* Timeline mode: poster as background (only when show-image is enabled) */
  :global(body.show-image .movie--timeline.has-poster) {
    background-size: cover;
    background-position: center top;
  }

  /* Hide background when show-image is not enabled */
  :global(body:not(.show-image) .movie--timeline.has-poster) {
    background-image: none !important;
  }

  /* Text at bottom with dark gradient for readability */
  :global(body.show-image .movie--timeline.has-poster .movie-clickable) {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 0%,
      rgba(0, 0, 0, 0) 40%,
      rgba(0, 0, 0, 0.85) 100%
    );
  }

  /* Hide the img element in timeline mode */
  :global(.movie--timeline .movie-poster) {
    display: none !important;
  }

  /* Ensure text is readable on poster background (only when showing images) */
  :global(body.show-image .movie--timeline.has-poster .movie-time) {
    color: var(--accent);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
  }

  :global(body.show-image .movie--timeline.has-poster .movie-title),
  :global(body.show-image .movie--timeline.has-poster .movie-meta) {
    color: #fff;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
  }

  /* Confirm modal styles */
  :global(.confirm-modal-content) {
    max-width: 380px;
    text-align: center;
  }

  :global(.confirm-buttons) {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  :global(.confirm-btn) {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    border: none;
    transition: background 0.15s, color 0.15s;
  }

  :global(.confirm-btn-cancel) {
    background: var(--bg-movie);
    color: var(--text-secondary);
  }

  :global(.confirm-btn-cancel:hover) {
    background: var(--bg-movie-hover);
    color: var(--text-primary);
  }

  :global(.confirm-btn-ok) {
    background: var(--accent);
    color: #fff;
  }

  :global(.confirm-btn-ok:hover) {
    background: var(--accent-bg);
  }
</style>
