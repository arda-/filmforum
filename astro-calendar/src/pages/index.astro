---
import Layout from '../layouts/Layout.astro';
import CalendarGrid from '../components/CalendarGrid.astro';
import DayCell from '../components/DayCell.astro';
import MovieModal from '../components/MovieModal.astro';
import { Switch } from 'webcoreui/astro';

// Generate Feb 2026 dates
const dates: string[] = [];
for (let i = 1; i <= 28; i++) {
  dates.push(`2026-02-${i.toString().padStart(2, '0')}`);
}
---

<Layout title="Tenement Stories - Film Forum Feb 2026">
  <h1>Tenement Stories: Timeline View</h1>
  <p class="subtitle">Film Forum, NYC, February 2026</p>

  <div class="controls">
    <Switch id="week-start-toggle" label="Start week on Monday" checked small />
    <Switch id="duration-mode-toggle" label="Duration mode" checked small />
    <Switch id="fit-width-toggle" label="Fit to width" checked small />
    <Switch id="hide-work-hours-toggle" label="Hide weekday 9-5 showtimes" small />
  </div>

  <CalendarGrid>
    {dates.map(date => (
      <DayCell date={date} />
    ))}
  </CalendarGrid>

  <p class="legend">Click any movie for details. Times are PM unless marked "FF Jr."</p>

  <MovieModal />
</Layout>

<script>
  const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const PX_PER_MIN = 0.7;

  interface Movie {
    Movie: string;
    Time: string;
    Tickets: string;
    Datetime: string;
    year?: string;
    director?: string;
    runtime?: string;
    actors?: string;
    description?: string;
    country?: string;
    film_url?: string;
    poster_url?: string;
    _col?: number;
    _hasOverlap?: boolean;
  }

  let moviesByDate: Record<string, Movie[]> = {};
  let globalRange = { start: Infinity, end: 0, range: 0 };
  let uniformHeight = 0;

  function toTitleCase(str: string) {
    return str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
  }

  function parseTimeToMins(timeStr: string) {
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (!match) return 0;
    let h = parseInt(match[1]);
    const m = parseInt(match[2]);
    // FF Jr. shows are morning (AM)
    const isMorning = timeStr.includes('FF Jr');
    // 12:XX is always noon (PM), 1-11 without FF Jr are PM
    if (!isMorning && h !== 12 && h < 12) h += 12;
    return h * 60 + m;
  }

  function getDayTimeRange(movies: Movie[]) {
    let minStart = Infinity, maxEnd = 0;
    movies.forEach(m => {
      const start = parseTimeToMins(m.Time);
      const runtime = parseInt(m.runtime || '90');
      const end = start + runtime;
      if (start < minStart) minStart = start;
      if (end > maxEnd) maxEnd = end;
    });
    return { start: minStart, end: maxEnd, range: maxEnd - minStart };
  }

  function assignOverlapColumns(movies: Movie[]) {
    const sorted = [...movies].sort((a, b) => parseTimeToMins(a.Time) - parseTimeToMins(b.Time));
    sorted.forEach((movie, i) => {
      movie._col = 0;
      movie._hasOverlap = false;
      const myStart = parseTimeToMins(movie.Time);
      for (let j = 0; j < i; j++) {
        const prev = sorted[j];
        const prevEnd = parseTimeToMins(prev.Time) + parseInt(prev.runtime || '90');
        if (prevEnd > myStart) {
          movie._col = 1;
          prev._hasOverlap = true;
          movie._hasOverlap = true;
          break;
        }
      }
    });
    return sorted;
  }

  function createMovieElement(movie: Movie, isTimeline: boolean, topPx?: number, heightPx?: number) {
    const el = document.createElement('div');
    const classes = ['movie'];
    if (isTimeline) {
      classes.push('movie--timeline');
      if (movie._col === 1) classes.push('overlap-col-1');
      else if (movie._hasOverlap) classes.push('overlap-col-0', 'has-overlap');
    }
    el.className = classes.join(' ');

    if (isTimeline && topPx !== undefined && heightPx !== undefined) {
      el.style.top = `${topPx + 28}px`;
      el.style.height = `${heightPx}px`;
    }

    const runtime = movie.runtime ? movie.runtime.replace(' minutes', 'min').replace(' ', '') : '';
    const metaText = [movie.year, movie.director, runtime].filter(Boolean).join(', ');
    const actors = movie.actors ? movie.actors.split(',').slice(0, 3).map(a => a.trim()).join(', ') : '';

    // Store movie data for modal
    el.dataset.movie = JSON.stringify(movie);
    el.setAttribute('tabindex', '0');
    el.setAttribute('role', 'button');

    el.innerHTML = `
      <div class="movie-clickable">
        <span class="movie-time">${movie.Time}</span>
        <span class="movie-title">${toTitleCase(movie.Movie)}</span>
        <div class="movie-meta">
          <span class="movie-info">${metaText}</span>
          ${actors ? `<span class="movie-actors">${actors}</span>` : ''}
        </div>
      </div>
    `;
    return el;
  }

  function renderAllDays() {
    const durationMode = (document.getElementById('duration-mode-toggle') as HTMLInputElement).checked;
    const hideWorkHoursEl = document.getElementById('hide-work-hours-toggle');
    const hideWorkHours = hideWorkHoursEl?.tagName === 'INPUT'
      ? (hideWorkHoursEl as HTMLInputElement).checked
      : (hideWorkHoursEl?.querySelector('input') as HTMLInputElement)?.checked;
    const WORK_START = 9 * 60;   // 9:00 AM = 540 mins
    const WORK_END = 17 * 60;    // 5:00 PM = 1020 mins

    Object.entries(moviesByDate).forEach(([date, dayMovies]) => {
      // Apply work hours filter if enabled (only on weekdays)
      let filteredMovies = dayMovies;
      if (hideWorkHours) {
        // Check if this date is a weekday (Mon-Fri = 1-5, Sat = 6, Sun = 0)
        const dayOfWeek = new Date(date + 'T12:00:00').getDay();
        const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;

        if (isWeekday) {
          filteredMovies = dayMovies.filter(m => {
            const mins = parseTimeToMins(m.Time);
            return mins < WORK_START || mins >= WORK_END;
          });
        }
      }
      const dayCell = document.querySelector(`[data-date="${date}"]`) as HTMLElement;
      if (!dayCell) return;

      // Clear and reset
      const dayNumber = dayCell.dataset.dayNumber;
      dayCell.innerHTML = '';
      dayCell.classList.remove('timeline-view');
      dayCell.classList.add('has-movies');
      dayCell.style.height = '';

      // Re-add day number
      const dayNumDiv = document.createElement('div');
      dayNumDiv.className = 'day-number';
      dayNumDiv.textContent = dayNumber || '';
      dayCell.appendChild(dayNumDiv);

      if (filteredMovies.length === 0) {
        dayCell.classList.remove('has-movies');
        return;
      }

      if (durationMode) {
        dayCell.style.height = `${uniformHeight}px`;
        dayCell.classList.add('timeline-view');
        const sorted = assignOverlapColumns(filteredMovies);
        sorted.forEach(movie => {
          const start = parseTimeToMins(movie.Time);
          const runtime = parseInt(movie.runtime || '90');
          const topPx = (start - globalRange.start) * PX_PER_MIN;
          const heightPx = Math.max(runtime * PX_PER_MIN, 24);
          dayCell.appendChild(createMovieElement(movie, true, topPx, heightPx));
        });
      } else {
        filteredMovies.forEach(movie => {
          dayCell.appendChild(createMovieElement(movie, false));
        });
      }
    });
  }

  // Initialize
  document.getElementById('week-start-toggle')?.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    document.body.classList.toggle('monday-start', checked);
    document.body.classList.toggle('sunday-start', !checked);
  });

  document.getElementById('duration-mode-toggle')?.addEventListener('change', () => {
    renderAllDays();
  });

  document.getElementById('fit-width-toggle')?.addEventListener('change', (e) => {
    const checked = (e.target as HTMLInputElement).checked;
    document.body.classList.toggle('natural-width', !checked);
  });

  const hideWorkHoursToggle = document.getElementById('hide-work-hours-toggle');
  const hideWorkHoursInput = hideWorkHoursToggle?.tagName === 'INPUT'
    ? hideWorkHoursToggle
    : hideWorkHoursToggle?.querySelector('input');
  hideWorkHoursInput?.addEventListener('change', () => {
    renderAllDays();
  });

  // Fetch and render
  fetch('/tenement-stories-full.json')
    .then(res => res.json())
    .then((movies: Movie[]) => {
      movies.forEach(movie => {
        const date = movie.Datetime.split('T')[0];
        if (!moviesByDate[date]) moviesByDate[date] = [];
        moviesByDate[date].push(movie);
      });

      // Calculate global time range
      Object.values(moviesByDate).forEach(dayMovies => {
        const range = getDayTimeRange(dayMovies);
        if (range.start < globalRange.start) globalRange.start = range.start;
        if (range.end > globalRange.end) globalRange.end = range.end;
      });
      globalRange.range = globalRange.end - globalRange.start;
      uniformHeight = Math.max(globalRange.range * PX_PER_MIN, 100) + 32;

      renderAllDays();
    });

  // Modal management
  let modalDOM: HTMLElement | null = null;
  let overlayDOM: HTMLElement | null = null;

  function initModal() {
    modalDOM = document.getElementById('movie-modal');
    if (modalDOM) {
      overlayDOM = modalDOM.nextElementSibling as HTMLElement;

      // Close button handler
      const closeBtn = modalDOM.querySelector('[data-id="close"]');
      closeBtn?.addEventListener('click', closeModal);

      // Overlay click handler
      overlayDOM?.addEventListener('click', closeModal);

      // Escape key handler
      document.addEventListener('keydown', (e) => {
        if (modalDOM?.dataset.show === 'true' && e.key === 'Escape') {
          closeModal();
        }
      });
    }
  }

  function openModal() {
    if (modalDOM) {
      modalDOM.dataset.show = 'true';
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal() {
    if (modalDOM) {
      modalDOM.dataset.show = '';
      document.body.style.overflow = '';
    }
  }

  function formatDateTime(datetime: string) {
    const date = new Date(datetime);
    return date.toLocaleString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function formatShowtime(datetime: string) {
    const date = new Date(datetime);
    return date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function openMovieModal(movie: Movie) {
    const titleEl = document.getElementById('modal-title');
    const metaEl = document.getElementById('modal-meta');
    const actorsEl = document.getElementById('modal-actors');
    const descEl = document.getElementById('modal-description');
    const ticketsEl = document.getElementById('modal-buy-tickets') as HTMLAnchorElement;
    const disclaimerEl = document.getElementById('modal-disclaimer');
    const calendarBtn = document.getElementById('modal-add-calendar');
    const posterEl = document.getElementById('modal-poster') as HTMLImageElement;
    const posterPlaceholder = document.querySelector('.poster-placeholder') as HTMLElement;

    // Set poster image
    if (posterEl && posterPlaceholder) {
      if (movie.poster_url) {
        posterEl.src = movie.poster_url;
        posterEl.alt = movie.Movie;
        posterEl.style.display = 'block';
        posterPlaceholder.style.display = 'none';
      } else {
        posterEl.style.display = 'none';
        posterPlaceholder.style.display = 'block';
      }
    }

    if (titleEl) titleEl.textContent = toTitleCase(movie.Movie);

    if (metaEl) {
      const runtime = movie.runtime?.replace(' minutes', 'min') || '';
      metaEl.textContent = [movie.year, movie.director, runtime].filter(Boolean).join(' Â· ');
    }

    if (actorsEl) {
      if (movie.actors) {
        const actorSpans = movie.actors.split(',').map(a => `<span>${a.trim()}</span>`).join(', ');
        actorsEl.innerHTML = actorSpans;
        actorsEl.style.display = 'block';
      } else {
        actorsEl.style.display = 'none';
      }
    }

    if (descEl) {
      descEl.textContent = movie.description || 'No description available.';
    }

    if (ticketsEl) {
      ticketsEl.href = movie.Tickets;
    }

    if (disclaimerEl) {
      const date = new Date(movie.Datetime);
      const showtime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      disclaimerEl.textContent = `When buying, select the ${showtime} showtime on ${dateStr}`;
    }

    // Set up calendar button
    if (calendarBtn) {
      calendarBtn.onclick = () => downloadICS(movie);
    }

    // Set up film page link
    const filmPageEl = document.getElementById('modal-film-page') as HTMLAnchorElement;
    if (filmPageEl) {
      if (movie.film_url) {
        filmPageEl.href = movie.film_url;
        filmPageEl.style.display = 'block';
      } else {
        filmPageEl.style.display = 'none';
      }
    }

    openModal();
  }

  function generateICS(movie: Movie): string {
    const startDate = new Date(movie.Datetime);
    const runtime = parseInt(movie.runtime || '90');
    const endDate = new Date(startDate.getTime() + runtime * 60000);

    const formatICSDate = (date: Date) => {
      return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    };

    const escapeICS = (str: string) => {
      return str.replace(/[\\;,\n]/g, (match) => {
        if (match === '\n') return '\\n';
        return '\\' + match;
      });
    };

    const title = `${toTitleCase(movie.Movie)} at Film Forum`;
    const location = 'Film Forum, 209 W Houston St, New York, NY 10014';
    const description = [
      movie.director ? `Director: ${movie.director}` : '',
      movie.year ? `Year: ${movie.year}` : '',
      movie.description ? movie.description.substring(0, 200) + (movie.description.length > 200 ? '...' : '') : ''
    ].filter(Boolean).join('\n');

    const uid = `${startDate.getTime()}-${movie.Movie.replace(/\s+/g, '')}@filmforum`;

    return [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Film Forum Calendar//EN',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${formatICSDate(new Date())}`,
      `DTSTART:${formatICSDate(startDate)}`,
      `DTEND:${formatICSDate(endDate)}`,
      `SUMMARY:${escapeICS(title)}`,
      `LOCATION:${escapeICS(location)}`,
      `DESCRIPTION:${escapeICS(description)}`,
      movie.Tickets ? `URL:${movie.Tickets}` : '',
      'END:VEVENT',
      'END:VCALENDAR'
    ].filter(Boolean).join('\r\n');
  }

  function downloadICS(movie: Movie) {
    const icsContent = generateICS(movie);
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `${movie.Movie.replace(/\s+/g, '-').toLowerCase()}-film-forum.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // Event delegation for movie clicks
  document.addEventListener('DOMContentLoaded', () => {
    initModal();

    document.querySelector('.calendar')?.addEventListener('click', (e) => {
      const movieEl = (e.target as HTMLElement).closest('[data-movie]');
      if (movieEl) {
        const movie = JSON.parse((movieEl as HTMLElement).dataset.movie || '{}');
        openMovieModal(movie);
      }
    });

    // Keyboard accessibility
    document.querySelector('.calendar')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        const movieEl = (e.target as HTMLElement).closest('[data-movie]');
        if (movieEl) {
          e.preventDefault();
          const movie = JSON.parse((movieEl as HTMLElement).dataset.movie || '{}');
          openMovieModal(movie);
        }
      }
    });
  });
</script>

<style>
  /* Day number styles (for dynamically recreated elements) */
  :global(.day-number) {
    font-size: 12px;
    font-weight: 300;
    color: var(--text-tertiary);
    margin-bottom: 8px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    text-transform: uppercase;
    letter-spacing: -0.005em;
  }

  @media (min-width: 480px) {
    :global(.day-number) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      text-transform: none;
      letter-spacing: normal;
      font-weight: 400;
    }
  }

  :global(.day.has-movies .day-number) {
    color: var(--text-secondary);
  }

  :global(.day.timeline-view .day-number) {
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 20;
    margin-bottom: 0;
  }

  /* Client-side injected movie styles */
  :global(.movie) {
    background: var(--bg-movie);
    border-radius: 0;
    margin: 0 0 4px 0;
    font-size: 12px;
    line-height: 1;
    border-left: none;
  }

  @media (min-width: 480px) {
    :global(.movie) {
      font-size: 13px;
    }
  }

  :global(.movie) {
    cursor: pointer;
  }

  :global(.movie:hover),
  :global(.movie:focus) {
    background: var(--bg-movie-hover);
    outline: none;
  }

  :global(.movie:focus-visible) {
    box-shadow: 0 0 0 2px var(--accent);
  }

  :global(.movie-clickable) {
    display: block;
    padding: 4px;
    color: var(--text-primary);
  }

  :global(.movie-time) {
    color: var(--accent);
    font-weight: 400;
    margin-right: 3px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.015em;
    text-transform: uppercase;
  }

  :global(.movie-title) {
    font-weight: 400;
    font-family: 'Barlow Semi Condensed', sans-serif;
    letter-spacing: -0.005em;
    text-transform: uppercase;
  }

  @media (min-width: 640px) {
    :global(.movie) {
      line-height: 1;
    }
    :global(.movie-time),
    :global(.movie-title) {
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      letter-spacing: normal;
      font-weight: 500;
      text-transform: none;
    }
  }

  :global(.movie-meta) {
    color: var(--text-tertiary);
    font-size: 0.85em;
    margin-top: 0.25em;
    line-height: 1.05;
    font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: none;
  }

  @media (min-width: 640px) {
    :global(.movie-meta) {
      display: block;
    }
  }

  :global(.movie-actors) {
    display: none;
    font-style: italic;
    margin-top: 0.3em;
  }

  @media (min-width: 1024px) {
    :global(.movie-actors) {
      display: block;
    }
  }

  :global(.movie--timeline) {
    position: absolute;
    left: 0;
    right: 0;
    overflow: hidden;
    z-index: 1;
    margin-bottom: 0;
  }

  @media (min-width: 1024px) {
    :global(.movie--timeline) {
      left: 4px;
      right: 4px;
    }
  }

  :global(.movie--timeline .movie-clickable) {
    height: 100%;
  }

  :global(.movie--timeline.overlap-col-1) {
    left: 52% !important;
    right: 4px !important;
  }

  :global(.movie--timeline.overlap-col-0.has-overlap) {
    right: 52% !important;
    left: 4px !important;
  }
</style>
